# CUSTOMIZATION_LOG.md - カスタマイズ記録

> 共通機能（Layer 2）への変更を記録し、追跡可能にする

---

## 目的

1. **変更の追跡**: 何を、いつ、なぜ変更したかを記録
2. **フレームワーク更新時の対応**: 元の共通機能が更新された際、カスタマイズを再適用
3. **チーム共有**: カスタマイズ内容をチームで共有

---

## 記録ルール

### 記録が必要な変更

- 共通機能のフィールド追加/削除
- バリデーションルールの変更
- ビジネスロジックの変更
- UIレイアウトの大幅な変更

### 記録不要な変更

- UIテキスト（ボタンラベル、エラーメッセージ）の変更
- ブランドカラーの変更
- ロゴの差し替え

---

## カスタマイズ一覧

### AUTH-001: ログイン

| 日付 | セクション | 変更内容 | 理由 | 変更者 |
|------|-----------|---------|------|-------|
| 2026-02-09 | §1.3 スコープ | Google OAuth を In Scope に追加 | MVP で Google ログイン必要 | AI |
| 2026-02-09 | §2.1 受入条件 | ロール別リダイレクト先テーブル追加 | 8ロール＋管理者のリダイレクト先定義 | AI |
| 2026-02-09 | §2.1 AC-005 | セッション有効期限 24h → 7日 | Better Auth デフォルトに合わせる | AI |
| 2026-02-09 | §5 API | JWT → Cookie セッション / login-context API 追加 | Better Auth 標準 + テナント自動識別 | AI |
| 2026-02-09 | §7 ビジネスロジック | テナント自動識別ロジック追加 / OAuth フロー追加 | 1ユーザー1テナント固定 | AI |

**変更差分**:

```diff
# §1.3 スコープ — In Scope
  - メール/パスワード認証
+ - Google OAuth 認証
  - セッション作成
- - ログイン後のリダイレクト
+ - ロール別リダイレクト
+ - テナント自動識別（user_tenant.is_default 使用）

# §5 API — レスポンス
- JWT トークン（access_token / refresh_token）
+ Cookie セッション（Better Auth 標準）

# §5 API — エンドポイント追加
+ POST /api/v1/auth/login-context（テナント・ロール取得）

# §7 ビジネスロジック
+ Google OAuth ログインフロー追加
+ テナント自動識別ロジック追加（is_default = true）
+ ロール別リダイレクト先マッピング追加
```

---

### AUTH-005: ログアウト

| 日付 | セクション | 変更内容 | 理由 | 変更者 |
|------|-----------|---------|------|-------|
| 2026-02-09 | §1.3 スコープ | 確認ダイアログを Out of Scope に | ユーザー確認で不要と決定 | AI |
| 2026-02-09 | §5 API | Bearer トークン → Better Auth Cookie | Better Auth 標準 | AI |
| 2026-02-09 | §7 ビジネスロジック | ローカルストレージ → Pinia クリア | Nuxt 3 アーキテクチャ | AI |

**変更差分**:

```diff
# §1.3 スコープ — Out of Scope
+ - 確認ダイアログ（不要と確定）

# §5 API
- POST /api/v1/auth/logout (Bearer トークン)
+ POST /api/auth/sign-out (Better Auth Cookie セッション)

# §7 ビジネスロジック
- ローカルストレージ/Cookie のトークン削除
+ Pinia ストア（authStore, tenantStore）リセット
```

---

### ACCT-001: サインアップ

| 日付 | セクション | 変更内容 | 理由 | 変更者 |
|------|-----------|---------|------|-------|
| 2026-02-09 | §1.3 スコープ | 招待制＋セルフ登録の両方対応 | ユーザー確認で両方必要 | AI |
| 2026-02-09 | §1.3 スコープ | Google OAuth サインアップ追加 | ログインと同様に対応 | AI |
| 2026-02-09 | §2.1 受入条件 | 3つのサインアップフロー定義 | 招待/セルフ/OAuth | AI |
| 2026-02-09 | §5 API | 招待トークン検証・受諾 API 追加 | 招待制フロー用 | AI |
| 2026-02-09 | §7 ビジネスロジック | 招待フロー: user_tenant 自動作成 | テナント・ロール自動付与 | AI |
| 2026-02-09 | §7 ビジネスロジック | セルフ登録: テナント未所属で作成 | オンボーディングで後から参加 | AI |

**変更差分**:

```diff
# §1.3 スコープ — In Scope
- - メール/パスワードでの新規登録
+ - メール/パスワードでの新規登録（セルフ登録）
+ - 招待リンク経由でのサインアップ
+ - Google OAuth サインアップ

# §2.1 受入条件
+ - 招待フロー: トークン検証 → フォーム → user + user_tenant 作成
+ - セルフ登録: フォーム → user 作成（テナント未所属）
+ - OAuth: Google 認証 → user 作成

# §5 API — エンドポイント追加
+ GET /api/v1/invitations/:token（招待トークン検証）
+ POST /api/v1/invitations/:token/accept（招待受諾・ユーザー作成）

# §7 ビジネスロジック
+ 招待フロー: invitation.tenant_id + role でuser_tenant自動作成
+ セルフ登録: user のみ作成、/onboarding へリダイレクト
+ OAuth: Better Auth socialProviders.google 使用
```

---

### （テンプレート）機能ID: 機能名

| 日付 | セクション | 変更内容 | 理由 | 変更者 |
|------|-----------|---------|------|-------|
| YYYY-MM-DD | X.X | | | |

**変更差分**:

```diff
# セクション名
- 元の内容
+ 変更後の内容
```

---

## カスタマイズ影響マトリクス

カスタマイズが他の機能に与える影響を記録:

| カスタマイズ | 影響を受ける機能 | 対応状況 | 対応日 | 対応内容 |
|------------|----------------|---------|--------|---------|
| ACCT-001に招待制追加 | ROLE-001（ロール管理） | ☑ 対応済 | 2026-02-09 | ROLE-001 v1.1: §5.2 招待API連携追記, §7 BR-005 招待ロール付与ルール追加 |
| ACCT-001にOAuth追加 | AUTH-001（ログイン） | ☑ 対応済 | 2026-02-09 | AUTH-001 §5.4 Google OAuth フロー, §7.2 OAuth ログインフロー |
| AUTH-001にロール別リダイレクト追加 | ROLE-001（ロール管理） | ☑ 対応済 | 2026-02-09 | ROLE-001 v1.1: §2.4 ユーザーフロー修正(login-context API), §7 BR-004 ロール別リダイレクト先テーブル追加 |
| AUTH-001にCookieセッション変更 | AUTH-005（ログアウト） | ☑ 対応済 | 2026-02-09 | AUTH-005: §5 API変更(Better Auth signOut), §7 Pinia storeリセット |
| AUTH-001にテナント自動識別追加 | ACCT-001（サインアップ） | ☑ 対応済 | 2026-02-09 | ACCT-001: §7 招待フローでis_default=true自動セット |

---

## フレームワーク更新時の手順

共通機能（common-features/）が更新された場合:

```
1. 更新内容を確認
2. このログのカスタマイズ一覧を確認
3. 各機能について:
   a. カスタマイズなし → 新しいバージョンをそのまま使用
   b. カスタマイズあり → 差分を新バージョンに再適用
4. このログを更新
```

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| 2026-02-09 | 初版作成 | AI |
| 2026-02-09 | AUTH-001, AUTH-005, ACCT-001 カスタマイズ記録追加 | AI |
| 2026-02-09 | Impact Matrix 全項目対応完了（ROLE-001 v1.1 反映） | AI |
