# AUTH-005: ログアウト機能

## メタ情報

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-005 |
| 機能名 | ログアウト機能 |
| カテゴリ | 認証・認可 |
| 優先度 | P0 |
| ステータス | Approved |
| 作成日 | 2026-02-09 |
| 最終更新日 | 2026-02-09 |
| ベース | common-features/auth/AUTH-005_logout.md |

---

## 1. 概要

### 1.1 機能の目的

ユーザーが現在のセッションを終了し、安全にログアウト状態に戻る機能。

### 1.2 ユーザーストーリー

```
As a ログイン済みユーザー,
I want to ログアウトしたい,
so that セッションを安全に終了できる.
```

### 1.3 スコープ

**In Scope**:
- 現在のセッションの無効化（Better Auth）
- Cookie の破棄
- Pinia ストアのクリア
- ログイン画面へのリダイレクト

**Out of Scope**:
- 全デバイスからのログアウト（AUTH-009 で対応）
- ログアウト確認のメール通知
- 確認ダイアログ（不要と確定）

---

## 2. 受入条件（Acceptance Criteria）

### 2.1 正常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-001 | ログアウトボタンをクリックすると、確認なしで即座にセッションが無効化される | 統合テスト |
| AC-002 | ログアウト後、/login にリダイレクトされる | E2Eテスト |
| AC-003 | ログアウト後、「ログアウトしました」のトーストメッセージが表示される | E2Eテスト |
| AC-004 | ログアウト後、Protected ページにアクセスすると /login にリダイレクトされる | E2Eテスト |

### 2.2 異常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-101 | ネットワークエラー時でもローカルの状態はクリアされ、/login に遷移する | ユニットテスト |
| AC-102 | すでにログアウト済みの状態で再度ログアウトしても正常に /login に遷移する（冪等性） | ユニットテスト |

### 2.3 エッジケース

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-201 | 複数タブで開いている場合、1つのタブでログアウトすると他のタブも認証状態を失う | E2Eテスト |
| AC-202 | ログアウト中に別の API リクエストが 401 を返しても、正常にログアウト処理が完了する | 統合テスト |

### 2.4 入出力例（§3-E） [DETAIL]

| # | 入力 | 条件 | 期待出力 | 備考 |
|---|------|------|---------|------|
| 1 | click: logout_button | 有効セッション（通常7日Cookie） | 200, Set-Cookie: maxAge=0, Pinia クリア → /login?reason=logout | 基本の正常系 |
| 2 | click: logout_button | 有効セッション（remember_me ON、30日Cookie） | 200, Set-Cookie: maxAge=0（30日Cookie含む）, Pinia クリア → /login?reason=logout | 長期セッションも即時無効化 |
| 3 | click: logout_button | 期限切れセッション | 200（冪等性）, Pinia クリア → /login?reason=logout | Better Auth が無効セッションでも200返却 |
| 4 | POST /api/auth/sign-out | セッションなし（未認証） | 200（Better Auth 標準）, → /login | Cookie がなくてもエラーにならない |
| 5 | click: logout_button | ネットワークエラー（API到達不可） | fetch 失敗, Pinia クリア → /login?reason=logout | エラーでもローカルクリア+遷移 |
| 6 | click: logout_button | 別タブでログアウト済み（セッション無効化済み） | 200（冪等性）, Pinia クリア → /login?reason=logout | 複数タブ対応 |

### 2.5 境界値（§3-F） [DETAIL]

| 項目 | 最小値 | 最大値 | 空 | NULL | 不正形式 |
|------|--------|--------|-----|------|---------|
| セッション | 有効（作成直後） → 正常ログアウト | 有効（期限直前） → 正常ログアウト | なし（Cookie なし） → 200（冪等性） | - | 期限切れセッション → 200（冪等性）、無効化済みセッション → 200（冪等性） |
| Cookie | 有効な session Cookie → 正常ログアウト | - | Cookie なし → 200（冪等性）, /login 遷移 | - | 改ざんされた Cookie → 200（Better Auth がセッション不正と判定）, /login 遷移 |
| 同時セッション数 | 1セッション → 当該セッションのみ無効化 | 3セッション（最大） → 当該セッションのみ無効化 | 0セッション → 200（冪等性） | - | - |

### 2.6 例外レスポンス（§3-G） [DETAIL]

| # | 例外条件 | HTTPステータス | エラーコード | ユーザーメッセージ | リトライ可否 | 復旧方法 |
|---|---------|---------------|------------|-----------------|------------|---------|
| 1 | ネットワークエラー（API到達不可） | -（fetch 失敗） | NETWORK_ERROR | （メッセージなし、ローカルクリアで対応） | Yes | 再試行不要（ローカルクリア+/login遷移で完了） |
| 2 | サーバーエラー | 500 | INTERNAL_ERROR | （メッセージなし、ローカルクリアで対応） | Yes | 再試行不要（ローカルクリア+/login遷移で完了） |
| 3 | セッション無効（期限切れ/無効化済み） | 200（Better Auth 標準） | - | （すでにログアウト済み扱い） | No | 不要（正常完了と同等） |
| 4 | CSRF 検証失敗 | 403 | CSRF_ERROR | （メッセージなし、ローカルクリアで対応） | Yes | ページリロード後に再試行 |
| 5 | サーバータイムアウト | 504 | TIMEOUT | （メッセージなし、ローカルクリアで対応） | Yes | 再試行不要（ローカルクリア+/login遷移で完了） |

### 2.7 受け入れテスト（§3-H Gherkin） [DETAIL]

```gherkin
Feature: AUTH-005 ログアウト機能

  Background:
    Given ユーザー "organizer@example.com" がログイン済み
    And テナント "ビジョンセンター" にロール "organizer" で所属
    And セッション Cookie がセットされている

  Scenario: 正常ログアウト（即時セッション無効化+Cookie削除+リダイレクト+トースト）
    When ヘッダーのユーザーメニューから「ログアウト」をクリックする
    Then Better Auth signOut() が呼び出される
    And サーバー側でセッションが無効化される
    And Set-Cookie ヘッダーで session Cookie が削除される（maxAge=0）
    And "/login?reason=logout" にリダイレクトされる
    And トーストメッセージ「ログアウトしました」が表示される

  Scenario: ログアウトボタンが確認ダイアログなしで即実行される
    When ヘッダーのユーザーメニューから「ログアウト」をクリックする
    Then 確認ダイアログは表示されない
    And 即座にログアウト処理が開始される

  Scenario: ログアウト後にProtectedページにアクセスすると/loginにリダイレクトされる
    Given ユーザーがログアウト済み
    When "/app" にアクセスする
    Then "/login" にリダイレクトされる

  Scenario: ログアウト後にPiniaストア（auth, tenant）がクリアされる
    When ヘッダーのユーザーメニューから「ログアウト」をクリックする
    Then authStore が $reset() でリセットされる
    And tenantStore が $reset() でリセットされる
    And ストアの user, session, tenant データが null になる

  Scenario: ネットワークエラーでもログアウトが完了する
    Given ネットワーク接続が切断されている
    When ヘッダーのユーザーメニューから「ログアウト」をクリックする
    Then Better Auth signOut() が失敗する
    But Pinia ストアはクリアされる
    And "/login?reason=logout" にリダイレクトされる

  Scenario: すでにログアウト済みで再度ログアウト（冪等性）
    Given ユーザーのセッションが無効化済み
    When ログアウト API が呼び出される
    Then ステータスコード 200 が返される
    And "/login?reason=logout" にリダイレクトされる

  Scenario: 複数タブで1つログアウトすると他タブも認証喪失
    Given ユーザーが Tab A と Tab B でアプリを開いている
    When Tab A でログアウトする
    Then Tab A は "/login?reason=logout" にリダイレクトされる
    And Tab B で次回 API リクエスト時に 401 が返される
    And Tab B は "/login" にリダイレクトされる

  Scenario: ログアウト中に別API 401が返っても正常にログアウト完了
    Given ログアウト処理中にバックグラウンドの API リクエストが 401 を返す
    When ログアウト処理が実行される
    Then 401 エラーは無視される
    And ログアウト処理は正常に完了する
    And "/login?reason=logout" にリダイレクトされる
```

---

## 3. UI仕様

### 3.1 ログアウトボタンの配置

| 配置場所 | 要素 | 備考 |
|---------|------|------|
| ヘッダー（デスクトップ） | UDropdownMenu 内 | ユーザーアバター/名前クリックで開くドロップダウンの最下部 |
| サイドバー（モバイル） | UButton (variant="ghost") | メニュー最下部にアイコン + テキスト |

### 3.2 状態別表示

| 状態 | 表示 |
|------|------|
| 初期 | ログアウトメニュー項目有効 |
| 処理中 | ボタン無効 + loading |
| 完了 | /login へ遷移 + トースト表示 |

---

## 4. 状態遷移

### 4.1 遷移ルール

| 現在の状態 | イベント | 次の状態 | アクション |
|-----------|---------|---------|-----------|
| S1 (認証済み) | click_logout | 処理中 | Better Auth signOut() + Pinia クリア |
| 処理中 | success | S0 | /login?reason=logout へ遷移 + トースト |
| 処理中 | error | S0 | /login?reason=logout へ遷移（エラーでも遷移） |

---

## 5. API仕様

### 5.1 エンドポイント

Better Auth が提供するエンドポイントを使用:

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | /api/auth/sign-out | ログアウト | 必要（Cookie） |

Better Auth が内部で session テーブルのレコードを無効化し、セッション Cookie を削除する。

---

## 6. データモデル

### 6.1 関連テーブル

| テーブル | 操作 | 内容 |
|---------|------|------|
| session（Better Auth 管理） | UPDATE | セッション無効化 |

Better Auth が自動的に処理するため、直接の DB 操作は不要。

---

## 7. ビジネスロジック

### 7.1 処理フロー

```
1. ユーザーがログアウトボタンをクリック（確認ダイアログなし）

2. フロントエンド処理
   a. Better Auth クライアントの signOut() を呼び出し
   b. Pinia ストア（authStore, tenantStore 等）をリセット
   c. 結果に関わらず navigateTo('/login?reason=logout')

3. バックエンド処理（Better Auth 内部）
   a. セッション Cookie からセッション ID を取得
   b. session テーブルの該当レコードを無効化
   c. Set-Cookie でセッション Cookie を削除
```

### 7.2 セキュリティ要件

| 要件 | 実装 |
|------|------|
| セッション即時無効化 | Better Auth がサーバー側で session を無効化 |
| Cookie 削除 | Better Auth が Set-Cookie で maxAge=0 |
| CSRF 対策 | Cookie の SameSite=Lax + POST メソッド |

---

## 8. エラーハンドリング

### 8.1 フロントエンド

| エラー種別 | 処理 |
|-----------|------|
| ネットワークエラー | Pinia クリア済みなので、そのまま /login へ遷移 |
| 401 エラー | すでにログアウト済みとみなし、/login へ遷移 |
| 500 エラー | Pinia クリア済みなので、そのまま /login へ遷移 |

### 8.2 バックエンド

| エラー種別 | HTTPステータス | ログレベル |
|-----------|--------------|-----------|
| セッション無効 | 200（Better Auth 標準） | DEBUG |
| サーバーエラー | 500 | ERROR |

---

## 9. テスト仕様

### 9.1 ユニットテスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-001 | 有効なセッションでログアウト | セッション無効化 + Cookie 削除 |
| TC-002 | 無効なセッションでログアウト | エラーなし（冪等性） |
| TC-003 | ネットワークエラー時に Pinia クリア | ストアがリセットされる |

### 9.2 E2Eテスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-101 | ログアウトフロー | /login へ遷移 + トースト表示 |
| TC-102 | ログアウト後に Protected アクセス | /login へリダイレクト |

---

## 10. 非機能要件

| 指標 | 目標値 |
|------|-------|
| API 応答時間（p95） | < 200ms |

---

## 11. 依存関係

### 11.1 前提となる機能

| 機能ID | 機能名 |
|--------|-------|
| AUTH-001 | ログイン |

### 11.2 この機能に依存する機能

なし

---

## 12. 未決定事項・制約 [DETAIL]

### 12.1 未決定事項（TBD）

（全て決定済み）

> CORE層・CONTRACT層のTBDはゼロ。DETAIL層のTBDもゼロ。

### 12.2 前提条件

- AUTH-001 ログイン機能が実装済み
- Better Auth v1.4+ のセッション管理が稼働中
- Pinia ストア（authStore, tenantStore）が実装済み

### 12.3 制約事項

- セッション無効化は Better Auth の signOut() に委譲
- 確認ダイアログは不要（ヒアリングで確定）
- エラー発生時もユーザーは必ず /login に遷移させる
- Cookie の削除は Better Auth が Set-Cookie: maxAge=0 で処理

---

## 13. 実装メモ（AI向け）

### 13.1 実装順序

```
1. composables/useAuth.ts に logout() メソッド追加
2. ヘッダーのユーザーメニューにログアウト項目追加
3. サイドバー（モバイル）にログアウトボタン追加
4. /login ページで reason=logout 時のトースト表示
5. テスト
```

### 13.2 実装例

```typescript
// composables/useAuth.ts
async function logout() {
  try {
    await authClient.signOut();
  } catch {
    // エラーでも続行
  } finally {
    // Pinia ストアをリセット
    const authStore = useAuthStore();
    const tenantStore = useTenantStore();
    authStore.$reset();
    tenantStore.$reset();
    // リダイレクト
    await navigateTo('/login?reason=logout');
  }
}
```

### 13.3 注意事項

- ⚠️ Better Auth の signOut() の結果を待たずにストアをクリアする
- ⚠️ エラーが発生してもユーザーは必ず /login に遷移させる
- ⚠️ 確認ダイアログは不要（即時ログアウト）

---

## カスタマイズ差分（テンプレートとの差異）

| セクション | 変更内容 | 理由 |
|-----------|---------|------|
| §1.3 スコープ | 確認ダイアログを Out of Scope に | ユーザー確認で不要と決定 |
| §3.2 | 確認ダイアログ UI を削除 | 上記 |
| §5 API | Bearer トークン → Better Auth Cookie セッション | Better Auth 標準 |
| §7.1 | ローカルストレージ → Pinia ストアクリア | Nuxt 3 + Pinia アーキテクチャ |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|----------|---------|-------|
| 2026-02-09 | v1.0 | 初版作成（テンプレートからカスタマイズ） | AI |
| 2026-02-09 | v1.1 | §2.4-2.7 追加（入出力例6件、境界値3項目、例外レスポンス5件、Gherkin 8シナリオ）。§12 未決定事項・制約追加 | AI |
