# AUTH-006〜010: Better Auth 標準認証機能

## メタ情報

| 項目 | 内容 |
|------|------|
| 機能ID | AUTH-006, AUTH-007, AUTH-009, AUTH-010 |
| 機能名 | パスワードリセット / メール認証 / セッション管理 / セッション自動更新 |
| カテゴリ | 認証・認可 |
| 優先度 | P0 |
| ステータス | Approved |
| 作成日 | 2026-02-09 |
| 最終更新日 | 2026-02-09 |
| 実装方式 | Better Auth 標準機能（設定のみ、カスタムコード不要） |

---

## §1. 概要 [CORE]

### §1.1 機能の目的

Better Auth が標準で提供する認証補助機能群（パスワードリセット・メール認証・セッション管理・セッション自動更新）を設定のみで有効化し、セキュアな認証ライフサイクルを実現する。カスタムコードは原則不要であり、Better Auth の設定と UI ページの実装のみで対応する。

### §1.2 ユーザーストーリー

```
# AUTH-006: パスワードリセット
As a パスワードを忘れたユーザー,
I want to メール経由でパスワードをリセットしたい,
so that アカウントに再度アクセスできる.

# AUTH-007: メール認証
As a 新規登録ユーザー,
I want to メールアドレスの所有権を確認したい,
so that 正しいメールアドレスでサービスを利用できる.

# AUTH-009: セッション管理
As a ログイン済みユーザー,
I want to セッションが適切に管理されてほしい,
so that セキュリティを保ちながら利便性も確保できる.

# AUTH-010: セッション自動更新
As a アクティブなユーザー,
I want to セッションが自動的に延長されてほしい,
so that 操作中にログアウトされない.
```

### §1.3 スコープ

**In Scope（この機能でやること）**:
- AUTH-006: パスワードリセットメール送信、リセットトークン検証、パスワード更新、全セッション無効化
- AUTH-007: サインアップ時の確認メール自動送信、メール認証コールバック、確認メール再送信、未確認時のバナー表示
- AUTH-009: Cookie ベースセッション管理、セッション有効期限（7日/30日）、同時セッション制限（最大3）、Cookie セキュリティ設定
- AUTH-010: updateAge によるセッション自動延長、Cookie 有効期限の自動更新

**Out of Scope（この機能ではやらないこと）**:
- ログイン処理本体（AUTH-001 で対応）
- ログアウト処理（AUTH-005 で対応）
- 多要素認証（AUTH-008 で対応、Phase 2）
- パスワード変更（ログイン中のパスワード変更は ACCT-002 で対応）
- メール認証なしではログイン不可にする制限（MVP では未確認でもログイン可能）

---

## §2. 受入条件（Acceptance Criteria） [CONTRACT]

### §2.1 正常系

#### AUTH-006: パスワードリセット

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-006-001 | /forgot-password でメールアドレスを入力すると、リセットメールが送信される | 統合テスト |
| AC-006-002 | 未登録メールアドレスでも同じ「メールを送信しました」メッセージを表示する（情報漏洩防止） | 統合テスト |
| AC-006-003 | リセットメール内のリンクをクリックすると /reset-password?token=xxx に遷移する | E2Eテスト |
| AC-006-004 | 有効なトークンで新しいパスワードを送信すると、パスワードが更新される | 統合テスト |
| AC-006-005 | パスワード更新後、全セッションが無効化される | 統合テスト |
| AC-006-006 | パスワード更新後、/login にリダイレクトし「パスワードが更新されました」トーストを表示する | E2Eテスト |

#### AUTH-007: メール認証

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-007-001 | サインアップ完了時に確認メールが自動送信される | 統合テスト |
| AC-007-002 | 確認メール内のリンクをクリックすると emailVerified = true に更新される | 統合テスト |
| AC-007-003 | 認証成功後、/app にリダイレクトし「メールアドレスが確認されました」トーストを表示する | E2Eテスト |
| AC-007-004 | メール未確認でもログイン・基本操作が可能 | E2Eテスト |
| AC-007-005 | メール未確認時、ダッシュボード上部にバナー「メールアドレスを確認してください」が表示される | E2Eテスト |
| AC-007-006 | バナーから確認メールの再送信が可能 | E2Eテスト |

#### AUTH-009: セッション管理

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-009-001 | セッションはデフォルトで7日間有効 | 統合テスト |
| AC-009-002 | rememberMe=true の場合、セッションは30日間有効 | 統合テスト |
| AC-009-003 | セッション Cookie は HttpOnly, Secure, SameSite=Lax で設定される | 統合テスト |
| AC-009-004 | 同時セッション数が3を超えた場合、最古のセッションが自動無効化される | 統合テスト |
| AC-009-005 | セッション情報は session テーブルに永続化される | 統合テスト |
| AC-009-006 | GET /api/auth/session で現在のセッション情報を取得できる | 統合テスト |

#### AUTH-010: セッション自動更新

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-010-001 | セッション作成から24時間以上経過後のリクエストで、セッション有効期限が自動延長される | 統合テスト |
| AC-010-002 | Cookie の有効期限もセッションと同時に更新される | 統合テスト |
| AC-010-003 | セッション更新はバックグラウンドで行われ、UX に影響しない | E2Eテスト |
| AC-010-004 | 7日間（rememberMe=true の場合は30日間）操作がなかった場合、セッションは期限切れになる | 統合テスト |

### §2.2 異常系

#### AUTH-006: パスワードリセット

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-006-101 | 期限切れトークン（1時間超過）でリセットを試みると、エラーメッセージ「リセットリンクの有効期限が切れています」を表示する | 統合テスト |
| AC-006-102 | 使用済みトークンでリセットを試みると、エラーメッセージ「このリセットリンクは既に使用されています」を表示する | 統合テスト |
| AC-006-103 | 不正なトークン文字列でリセットを試みると、エラーメッセージ「無効なリセットリンクです」を表示する | 統合テスト |
| AC-006-104 | パスワードバリデーションエラー（8文字未満等）の場合、フィールドエラーを表示する | ユニットテスト |
| AC-006-105 | パスワードと確認パスワードが一致しない場合、フィールドエラーを表示する | ユニットテスト |
| AC-006-106 | レート制限（同一メール 3回/時間）超過時、「しばらく時間をおいてから再試行してください」を表示する | 統合テスト |

#### AUTH-007: メール認証

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-007-101 | 期限切れトークン（24時間超過）で認証を試みると、エラーメッセージ「確認リンクの有効期限が切れています。再送信してください」を表示する | 統合テスト |
| AC-007-102 | 不正なトークンで認証を試みると、エラーメッセージ「無効な確認リンクです」を表示する | 統合テスト |
| AC-007-103 | 既に認証済みのメールアドレスで再度認証を試みると、「既に確認済みです」を表示する | 統合テスト |

#### AUTH-009: セッション管理

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-009-101 | 期限切れセッションでアクセスした場合、401 を返しログイン画面にリダイレクトされる | 統合テスト |
| AC-009-102 | サーバー側で無効化されたセッション（パスワードリセット後等）でアクセスした場合、401 を返す | 統合テスト |
| AC-009-103 | 不正な Cookie 値でアクセスした場合、401 を返す | 統合テスト |

### §2.3 エッジケース

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-006-201 | パスワードリセットメール送信直後に再度リクエストした場合、レート制限内であれば新しいトークンが発行される（古いトークンは無効化） | 統合テスト |
| AC-006-202 | パスワードリセット中にアカウントが無効化された場合、リセット処理は失敗する | 統合テスト |
| AC-007-201 | 確認メール再送信のレート制限（同一メール 3回/時間）超過時、エラーを返す | 統合テスト |
| AC-007-202 | 確認リンクをクリックした時点でセッションがない場合、/login にリダイレクトし「メールアドレスが確認されました。ログインしてください」を表示する | E2Eテスト |
| AC-009-201 | 3台のデバイスでログイン中に4台目でログインすると、最古のセッション（1台目）が無効化される | 統合テスト |
| AC-009-202 | 最古セッションが無効化されたデバイスで次のリクエスト時、401 が返り /login にリダイレクトされる | E2Eテスト |
| AC-010-201 | updateAge（24時間）経過前のリクエストではセッション有効期限は更新されない | 統合テスト |
| AC-010-202 | セッション更新中にサーバーエラーが発生しても、現在のリクエストは正常に処理される | 統合テスト |

### §3-E. 入出力例 [CONTRACT]

> Better Auth各機能の入出力パターン（正常系・異常系を網羅）

#### AUTH-006: パスワードリセット

| # | 入力 | 条件 | 期待出力 | 備考 |
|---|------|------|---------|------|
| 1 | POST /api/auth/forget-password, email: "user@example.com" | 登録済みメール | 200, { status: true } + リセットメール送信 | 成功レスポンスは常に同じ |
| 2 | POST /api/auth/forget-password, email: "unknown@example.com" | 未登録メール | 200, { status: true } | 情報漏洩防止で同じレスポンス |
| 3 | POST /api/auth/forget-password, email: "" | 空メール | 400, VALIDATION_ERROR | Zod バリデーション |
| 4 | POST /api/auth/reset-password, token: "valid_token", newPassword: "NewPass123!" | 有効トークン | 200, パスワード更新 + 全セッション無効化 | 成功 |
| 5 | POST /api/auth/reset-password, token: "expired_token", newPassword: "NewPass123!" | 期限切れトークン（1時間超過） | 400, TOKEN_EXPIRED | 期限切れ |
| 6 | POST /api/auth/reset-password, token: "used_token", newPassword: "NewPass123!" | 使用済みトークン | 400, TOKEN_ALREADY_USED | 再利用不可 |
| 7 | POST /api/auth/reset-password, token: "valid_token", newPassword: "short" | パスワード不正（8文字未満） | 400, VALIDATION_ERROR | バリデーション失敗 |

#### AUTH-007: メール認証

| # | 入力 | 条件 | 期待出力 | 備考 |
|---|------|------|---------|------|
| 8 | GET /api/auth/verify-email?token=valid_token | 有効トークン | emailVerified=true + /app にリダイレクト | 成功 |
| 9 | GET /api/auth/verify-email?token=expired_token | 期限切れトークン（24時間超過） | エラーページ表示 + 再送信リンク | 期限切れ |
| 10 | GET /api/auth/verify-email?token=invalid_token | 不正トークン | エラーページ表示 | 無効 |
| 11 | POST /api/auth/send-verification-email, email: "unverified@example.com" | 未確認メール | 200, 確認メール再送信 | 再送信成功 |
| 12 | POST /api/auth/send-verification-email, email: "verified@example.com" | 確認済みメール | 200, (メール送信しない) | 冪等性 |

#### AUTH-009: セッション管理

| # | 入力 | 条件 | 期待出力 | 備考 |
|---|------|------|---------|------|
| 13 | GET /api/auth/session (Cookie: valid_session) | 有効セッション | 200, { user, session } | 正常取得 |
| 14 | GET /api/auth/session (Cookie: expired_session) | 期限切れセッション | 401, UNAUTHORIZED | 期限切れ |
| 15 | GET /api/auth/session (Cookie: none) | Cookie なし | 401, UNAUTHORIZED | 未認証 |

### §2.5 境界値（§3-F） [DETAIL]

| 項目 | 最小値 | 最大値 | 空 | NULL | 不正形式 |
|------|--------|--------|-----|------|---------|
| reset email | "a@b.co" (6文字) → OK | 255文字 → OK | "" → VAL: "メールアドレスを入力してください" | undefined → VAL: "メールアドレスを入力してください" | "abc" → VAL: "有効なメールアドレスを入力してください" |
| reset email (256文字超) | - | 256文字 → 400 (Zod maxLength) | - | - | - |
| newPassword | "Aa1!aaaa" (8文字) → OK | 128文字 → OK | "" → VAL: "新しいパスワードを入力してください" | undefined → VAL: "新しいパスワードを入力してください" | "short" (7文字) → VAL: "パスワードは8文字以上で入力してください" |
| newPassword (129文字超) | - | 129文字 → 400 (Zod maxLength) | - | - | - |
| confirmPassword | newPassword と一致 → OK | - | "" → VAL: "確認用パスワードを入力してください" | undefined → VAL | "mismatch" → VAL: "パスワードが一致しません" |
| reset token | 有効な文字列 → OK | - | "" → 400 BAD_REQUEST | undefined → 400 BAD_REQUEST | "x" → 400 INVALID_TOKEN |
| reset token 有効期限 | 発行直後 → OK | 59分59秒 → OK | - | - | 60分00秒（ちょうど1時間） → 400 TOKEN_EXPIRED |
| verification token 有効期限 | 発行直後 → OK | 23時間59分59秒 → OK | - | - | 24時間00分00秒 → 期限切れ |
| session expiresIn (default) | - | 7日（604800秒） | - | - | - |
| session expiresIn (rememberMe) | - | 30日（2592000秒） | - | - | - |
| session updateAge | 24時間（86400秒）経過後 → 更新実行 | - | - | - | 24時間未満 → 更新しない |
| concurrent sessions | 1 → OK | 3 → OK | - | - | 4 → 最古を無効化 |
| reset rate limit | 1回/時 → OK | 3回/時 → OK | - | - | 4回/時 → 429 RATE_LIMITED |

### §2.6 例外レスポンス（§3-G） [DETAIL]

| # | 例外条件 | HTTPステータス | エラーコード | ユーザーメッセージ | リトライ可否 | 復旧方法 |
|---|---------|---------------|------------|-----------------|------------|---------|
| 1 | リセットトークン期限切れ | 400 | TOKEN_EXPIRED | リセットリンクの有効期限が切れています。再度リセットをリクエストしてください | Yes | 再リクエスト |
| 2 | リセットトークン使用済み | 400 | TOKEN_ALREADY_USED | このリセットリンクは既に使用されています | Yes | 再リクエスト |
| 3 | リセットトークン不正 | 400 | INVALID_TOKEN | 無効なリセットリンクです | Yes | 再リクエスト |
| 4 | リセットメール レート制限 | 429 | RATE_LIMITED | しばらく時間をおいてから再試行してください（1時間に3回まで） | Yes (60min) | 時間経過 |
| 5 | パスワードバリデーション失敗 | 400 | VALIDATION_ERROR | パスワードは8文字以上で入力してください | Yes | 再入力 |
| 6 | パスワード不一致 | 400 | VALIDATION_ERROR | パスワードが一致しません | Yes | 再入力 |
| 7 | 認証トークン期限切れ | 400 | TOKEN_EXPIRED | 確認リンクの有効期限が切れています。再送信してください | Yes | 再送信 |
| 8 | 認証トークン不正 | 400 | INVALID_TOKEN | 無効な確認リンクです | Yes | 再送信 |
| 9 | 既に認証済み | 200 | - | 既に確認済みです | - | - |
| 10 | セッション期限切れ | 401 | UNAUTHORIZED | セッションの有効期限が切れました。再度ログインしてください | Yes | 再ログイン |
| 11 | セッション無効化済み | 401 | UNAUTHORIZED | セッションが無効です。再度ログインしてください | Yes | 再ログイン |
| 12 | 同時セッション超過（通知） | - | - | 別のデバイスでログインしたため、このセッションは終了しました | Yes | 再ログイン |
| 13 | メール送信失敗 | 500 | INTERNAL_ERROR | メールの送信に失敗しました。しばらく経ってから再試行してください | Yes | 再試行 |
| 14 | ネットワークエラー | - (fetch失敗) | NETWORK_ERROR | 通信エラーが発生しました。再試行してください | Yes | 再試行 |
| 15 | サーバーエラー | 500 | INTERNAL_ERROR | システムエラーが発生しました。しばらく経ってから再試行してください | Yes | 自動復旧待ち |

### §2.7 受入テスト（§3-H Gherkin） [DETAIL]

```gherkin
Feature: AUTH-006 パスワードリセット

  Background:
    Given ユーザー "user@example.com" が登録済み
    And パスワードが "OldPass123!" で設定済み

  Scenario: パスワードリセットメール送信（登録済みメール）
    When /forgot-password で email "user@example.com" を入力して送信する
    Then ステータスコード 200 が返される
    And 「パスワードリセットのメールを送信しました」メッセージが表示される
    And "user@example.com" にリセットメールが送信される
    And メール内にリセットリンク "/reset-password?token=xxx" が含まれる

  Scenario: パスワードリセットメール送信（未登録メール、情報漏洩防止）
    When /forgot-password で email "unknown@example.com" を入力して送信する
    Then ステータスコード 200 が返される
    And 「パスワードリセットのメールを送信しました」メッセージが表示される
    And メールは送信されない

  Scenario: リセットトークンで新パスワード設定
    Given 有効なリセットトークン "valid_token" が発行済み
    When /reset-password?token=valid_token にアクセスする
    And 新しいパスワード "NewPass123!" と確認パスワード "NewPass123!" を入力して送信する
    Then パスワードが "NewPass123!" に更新される
    And 全てのセッションが無効化される
    And /login にリダイレクトされる
    And 「パスワードが更新されました」トーストが表示される

  Scenario: 期限切れリセットトークン
    Given リセットトークン "expired_token" が1時間以上前に発行された
    When /reset-password?token=expired_token にアクセスして新パスワードを送信する
    Then エラーメッセージ「リセットリンクの有効期限が切れています」が表示される
    And 「再度リセットをリクエスト」リンクが表示される

  Scenario: 使用済みリセットトークン
    Given リセットトークン "used_token" が既に使用済み
    When /reset-password?token=used_token にアクセスして新パスワードを送信する
    Then エラーメッセージ「このリセットリンクは既に使用されています」が表示される

  Scenario: リセットメールのレート制限
    Given "user@example.com" に対して過去1時間以内に3回リセットメールを送信済み
    When 4回目のリセットメールを送信する
    Then ステータスコード 429 が返される
    And エラーメッセージ「しばらく時間をおいてから再試行してください」が表示される

  Scenario: パスワードバリデーションエラー
    Given 有効なリセットトークンでリセット画面を表示中
    When 新パスワード "short" を入力して送信する
    Then フィールドエラー「パスワードは8文字以上で入力してください」が表示される

  Scenario: パスワード確認不一致
    Given 有効なリセットトークンでリセット画面を表示中
    When 新パスワード "NewPass123!" と確認パスワード "Different456!" を入力して送信する
    Then フィールドエラー「パスワードが一致しません」が表示される

Feature: AUTH-007 メール認証

  Background:
    Given ユーザー "newuser@example.com" がサインアップ済み
    And emailVerified が false

  Scenario: サインアップ時の確認メール自動送信
    When サインアップが完了する
    Then "newuser@example.com" に確認メールが送信される
    And メール内に確認リンクが含まれる

  Scenario: メール認証成功
    Given 有効な確認トークン "verify_token" が発行済み
    And ユーザーがログイン済み
    When 確認リンク /api/auth/verify-email?token=verify_token にアクセスする
    Then emailVerified が true に更新される
    And /app にリダイレクトされる
    And 「メールアドレスが確認されました」トーストが表示される

  Scenario: メール未確認でもログイン可能
    Given ユーザー "newuser@example.com" の emailVerified が false
    When 正しいパスワードでログインする
    Then ログインに成功する
    And ダッシュボード上部に「メールアドレスを確認してください」バナーが表示される

  Scenario: 確認メール再送信
    Given メール未確認のユーザーがログイン済み
    When バナーの「確認メールを再送信」ボタンをクリックする
    Then 確認メールが再送信される
    And 「確認メールを送信しました」トーストが表示される

  Scenario: 確認トークン期限切れ
    Given 確認トークンが24時間以上前に発行された
    When 確認リンクにアクセスする
    Then エラーメッセージ「確認リンクの有効期限が切れています。再送信してください」が表示される
    And 「確認メールを再送信」ボタンが表示される

  Scenario: 未ログイン状態で確認リンクをクリック
    Given ユーザーがログインしていない
    When 有効な確認リンクにアクセスする
    Then emailVerified が true に更新される
    And /login にリダイレクトされる
    And 「メールアドレスが確認されました。ログインしてください」メッセージが表示される

Feature: AUTH-009 セッション管理

  Scenario: デフォルトセッション有効期限（7日）
    Given ユーザーが rememberMe=false でログインする
    Then セッションの有効期限は7日後に設定される
    And Cookie の有効期限も7日後に設定される

  Scenario: rememberMe ON のセッション有効期限（30日）
    Given ユーザーが rememberMe=true でログインする
    Then セッションの有効期限は30日後に設定される
    And Cookie の有効期限も30日後に設定される

  Scenario: Cookie セキュリティ設定
    When ログインに成功する
    Then セッション Cookie に HttpOnly 属性が設定される
    And セッション Cookie に Secure 属性が設定される
    And セッション Cookie の SameSite が Lax に設定される

  Scenario: 同時セッション数 3 以内
    Given ユーザーが3台のデバイスでログイン中
    Then 3つのセッション全てが有効である

  Scenario: 4台目ログインで最古セッション無効化
    Given ユーザーがデバイスA, B, C の順にログイン中（3セッション）
    When 4台目のデバイスDでログインする
    Then デバイスDでのログインに成功する
    And デバイスA（最古）のセッションが無効化される
    And デバイスB, C, D のセッションは有効のまま

  Scenario: 無効化されたセッションでのアクセス
    Given デバイスAのセッションが同時セッション超過により無効化された
    When デバイスAから API リクエストを送信する
    Then ステータスコード 401 が返される
    And /login にリダイレクトされる

Feature: AUTH-010 セッション自動更新

  Scenario: セッション自動延長（updateAge 超過後）
    Given ユーザーが24時間前にログインした
    And セッションの残り有効期限が6日
    When API リクエストを送信する
    Then セッションの有効期限がリクエスト時点から7日後に更新される
    And Cookie の有効期限も同時に更新される

  Scenario: セッション更新なし（updateAge 未到達）
    Given ユーザーが12時間前にログインした
    When API リクエストを送信する
    Then セッションの有効期限は更新されない

  Scenario: 非アクティブでセッション期限切れ
    Given ユーザーが7日間操作しなかった（rememberMe=false）
    When API リクエストを送信する
    Then ステータスコード 401 が返される
    And /login にリダイレクトされる
    And 「セッションの有効期限が切れました」メッセージが表示される

  Scenario: rememberMe ON で非アクティブ期限切れ
    Given ユーザーが rememberMe=true でログインした
    And 30日間操作しなかった
    When API リクエストを送信する
    Then ステータスコード 401 が返される
```

---

## §3. UI仕様 [CONTRACT]

### §3.1 画面一覧

| Screen ID | 画面名 | パス | 認証 | レイアウト | 対象機能 |
|-----------|-------|------|------|----------|---------|
| SCR-FORGOT | パスワードリセット申請画面 | /forgot-password | 不要 | auth | AUTH-006 |
| SCR-RESET | パスワードリセット実行画面 | /reset-password | 不要 | auth | AUTH-006 |
| CMP-VERIFY-BANNER | メール未確認バナー | (ダッシュボード上部) | 必要 | dashboard | AUTH-007 |

### §3.2 画面レイアウト

#### SCR-FORGOT: パスワードリセット申請画面

```
┌─────────────────────────────────────────────────┐
│                   [ロゴ]                         │
│              Haishin+ HUB                        │
│                                                  │
│         パスワードをリセット                        │
│                                                  │
├──────────────────────────────────────────────────┤
│                                                  │
│   ┌──────────────────────────────────────────┐   │
│   │  エラーメッセージバナー（エラー時のみ）      │   │
│   └──────────────────────────────────────────┘   │
│                                                  │
│   ┌──────────────────────────────────────────┐   │
│   │  成功メッセージバナー（送信完了時）          │   │
│   └──────────────────────────────────────────┘   │
│                                                  │
│   メールアドレス                                  │
│   ┌──────────────────────────────────────────┐   │
│   │ example@email.com                        │   │
│   └──────────────────────────────────────────┘   │
│   [フィールドエラー]                              │
│                                                  │
│   ┌──────────────────────────────────────────┐   │
│   │         リセットメールを送信              │   │
│   └──────────────────────────────────────────┘   │
│                                                  │
│   ログイン画面に戻る                              │
│                                                  │
└──────────────────────────────────────────────────┘
```

#### SCR-RESET: パスワードリセット実行画面

```
┌─────────────────────────────────────────────────┐
│                   [ロゴ]                         │
│              Haishin+ HUB                        │
│                                                  │
│          新しいパスワードを設定                     │
│                                                  │
├──────────────────────────────────────────────────┤
│                                                  │
│   ┌──────────────────────────────────────────┐   │
│   │  エラーメッセージバナー（エラー時のみ）      │   │
│   └──────────────────────────────────────────┘   │
│                                                  │
│   新しいパスワード                                │
│   ┌──────────────────────────────────────────┐   │
│   │ ••••••••                           [目]  │   │
│   └──────────────────────────────────────────┘   │
│   [フィールドエラー]                              │
│                                                  │
│   パスワード（確認）                               │
│   ┌──────────────────────────────────────────┐   │
│   │ ••••••••                           [目]  │   │
│   └──────────────────────────────────────────┘   │
│   [フィールドエラー]                              │
│                                                  │
│   ┌──────────────────────────────────────────┐   │
│   │          パスワードを更新                 │   │
│   └──────────────────────────────────────────┘   │
│                                                  │
└──────────────────────────────────────────────────┘
```

#### CMP-VERIFY-BANNER: メール未確認バナー

```
┌───────────────────────────────────────────────────────────────┐
│  ⚠ メールアドレスが確認されていません。                          │
│    確認メールを再送信する                              [×]     │
└───────────────────────────────────────────────────────────────┘
```

### §3.3 UI要素詳細

#### SCR-FORGOT

| 要素 | 種類 | バリデーション | 備考 |
|------|------|--------------|------|
| ロゴ | image | - | クリックで / へ遷移 |
| ページタイトル | h2 | - | 「パスワードをリセット」 |
| エラーバナー | UAlert (color="error") | - | API エラー時に表示 |
| 成功バナー | UAlert (color="success") | - | メール送信完了時に表示 |
| メールアドレス | UInput (type="email") | MUST: 必須、メール形式、最大255文字 | プレースホルダー: "example@email.com" |
| 送信ボタン | UButton (type="submit") | - | プライマリカラー、幅100% |
| ログイン戻りリンク | NuxtLink | - | → /login |

#### SCR-RESET

| 要素 | 種類 | バリデーション | 備考 |
|------|------|--------------|------|
| ロゴ | image | - | クリックで / へ遷移 |
| ページタイトル | h2 | - | 「新しいパスワードを設定」 |
| エラーバナー | UAlert (color="error") | - | トークンエラー・API エラー時に表示 |
| 新しいパスワード | UInput (type="password") | MUST: 必須、8文字以上、128文字以下 | 表示/非表示トグルあり |
| パスワード（確認） | UInput (type="password") | MUST: 必須、新パスワードと一致 | 表示/非表示トグルあり |
| 更新ボタン | UButton (type="submit") | - | プライマリカラー、幅100% |

#### CMP-VERIFY-BANNER

| 要素 | 種類 | バリデーション | 備考 |
|------|------|--------------|------|
| バナー | UAlert (color="warning") | - | ダッシュボード上部に固定表示 |
| 再送信リンク | UButton (variant="link") | - | クリックで再送信 API 呼び出し |
| 閉じるボタン | UButton (icon, variant="ghost") | - | バナーを一時的に非表示（リロードで再表示） |

### §3.4 状態別表示

#### SCR-FORGOT

| 状態 | 表示内容 |
|------|---------|
| 初期表示 | メールアドレス入力フォーム、バナー非表示 |
| 入力中 | リアルタイムバリデーション（フィールド離脱時） |
| バリデーションエラー | フィールド下に赤字でエラーメッセージ |
| 送信中 | ボタン無効化 + loading、テキスト「送信中...」 |
| 送信完了 | 成功バナー「パスワードリセットのメールを送信しました。メールをご確認ください」表示、フォームは維持（再送信可能） |
| サーバーエラー | エラーバナー表示 |
| レート制限 | 「しばらく時間をおいてから再試行してください」バナー表示 |

#### SCR-RESET

| 状態 | 表示内容 |
|------|---------|
| 初期表示（有効トークン） | パスワード入力フォーム表示 |
| 初期表示（無効トークン） | エラーバナー「無効なリセットリンクです」+ 「パスワードリセットを再リクエスト」リンク表示、フォーム非表示 |
| 入力中 | リアルタイムバリデーション（フィールド離脱時） |
| バリデーションエラー | フィールド下に赤字でエラーメッセージ |
| 送信中 | ボタン無効化 + loading、テキスト「更新中...」 |
| 更新成功 | /login にリダイレクト + 「パスワードが更新されました」トースト |
| トークン期限切れ | エラーバナー + 「パスワードリセットを再リクエスト」リンク表示 |
| サーバーエラー | エラーバナー表示 |

### §3.5 レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| モバイル（< 640px） | フォーム幅100%、左右 padding: 16px |
| タブレット（640-1024px） | フォーム幅80%、中央配置 |
| デスクトップ（> 1024px） | フォーム幅400px固定、中央配置 |

---

## §4. 状態遷移 [CONTRACT]

### §4.1 AUTH-006: パスワードリセット状態遷移

```
┌──────────────────┐
│  S0: 未認証       │
│  /forgot-password │
└────────┬─────────┘
         │ submit_email
         ▼
┌────────────────┐
│  処理中（送信） │
└────────┬───────┘
         │
    ┌────┴────┐
    │         │
  success   error
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│ 送信完了│ │エラー表示│
│ バナー  │ │→S0に戻る│
└────────┘ └────────┘

         ↓ メールリンククリック

┌──────────────────┐
│  /reset-password  │
│  ?token=xxx       │
└────────┬─────────┘
         │ submit_password
         ▼
┌────────────────┐
│  処理中（更新） │
└────────┬───────┘
         │
    ┌────┴────┐
    │         │
  success   error
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│ 更新完了│ │エラー表示│
│→/login │ │→再リクエ│
│  遷移   │ │ スト誘導│
└────────┘ └────────┘
```

### §4.2 AUTH-007: メール認証状態遷移

```
┌────────────────────┐
│  emailVerified:    │
│  false             │
│  (ログイン可能)      │
└────────┬───────────┘
         │
    ┌────┴────────┐
    │              │
  verify_click   resend_click
    │              │
    ▼              ▼
┌────────┐  ┌──────────┐
│ 認証処理│  │ 再送信処理│
└────┬───┘  └────┬─────┘
     │           │
  ┌──┴──┐     success
  │     │        │
success error    ▼
  │     │   ┌────────┐
  │     │   │再送信   │
  │     │   │完了     │
  │     │   └────────┘
  │     │
  │     ▼
  │  ┌────────────┐
  │  │ エラー表示   │
  │  │ (期限切れ等) │
  │  └────────────┘
  │
  ▼
┌────────────────────┐
│  emailVerified:    │
│  true              │
│  → /app リダイレクト │
│  + トースト表示      │
└────────────────────┘
```

### §4.3 AUTH-009/010: セッションライフサイクル

```
┌──────────────┐     login
│  セッションなし │ ────────────►  ┌──────────────────┐
└──────────────┘                 │  セッション有効     │
                                 │  (7日 or 30日)     │
       ┌─────────────────────────┤                    │
       │                         └──────┬─────────────┘
       │                                │
       │                    request after updateAge (24h)
       │                                │
       │                                ▼
       │                         ┌──────────────────┐
       │                         │  セッション更新     │
       │                         │  (有効期限を延長)   │
       │                         └──────┬─────────────┘
       │                                │
       │                                │ → セッション有効に戻る
       │                                │
       │  7日/30日間 操作なし
       │         │
       │         ▼
       │  ┌──────────────────┐
       │  │  セッション期限切れ  │
       │  │  → 401 + /login   │
       │  └──────────────────┘
       │
       │  4台目ログイン（同時3超過）
       │         │
       │         ▼
       │  ┌──────────────────┐
       │  │  最古セッション     │
       │  │  強制無効化        │
       │  │  → 401 + /login   │
       └──┤                    │
          └──────────────────┘
```

### §4.4 遷移ルール

| 現在の状態 | イベント | 次の状態 | アクション |
|-----------|---------|---------|-----------|
| /forgot-password 初期 | submit_email（バリデーション成功） | 処理中 | Better Auth forget-password API 呼び出し |
| 処理中（送信） | success | 送信完了 | 成功バナー表示 |
| 処理中（送信） | error (rate_limit) | エラー | レート制限メッセージ表示 |
| 処理中（送信） | error (server) | エラー | サーバーエラーメッセージ表示 |
| /reset-password 初期 | token 有効 | フォーム表示 | パスワード入力フォーム表示 |
| /reset-password 初期 | token 無効 | エラー | エラーバナー + 再リクエストリンク |
| フォーム表示 | submit_password（バリデーション成功） | 処理中 | Better Auth reset-password API 呼び出し |
| 処理中（更新） | success | 更新完了 | /login にリダイレクト + トースト |
| 処理中（更新） | error | エラー | エラーバナー表示 |
| emailVerified: false | verify_link_click | 認証処理中 | Better Auth verify-email 呼び出し |
| 認証処理中 | success | emailVerified: true | /app リダイレクト + トースト |
| 認証処理中 | error | エラー | エラー表示 + 再送信リンク |
| emailVerified: false | resend_click | 再送信処理中 | Better Auth send-verification-email 呼び出し |
| セッション有効 | request（updateAge 超過） | セッション更新 | 有効期限延長（バックグラウンド） |
| セッション有効 | request（updateAge 未到達） | セッション有効 | 変化なし |
| セッション有効 | 有効期限超過 | セッション期限切れ | 401 + /login リダイレクト |
| セッション有効 | 4台目ログイン | 最古セッション無効化 | 最古セッションの次リクエストで 401 |

---

## §5. API仕様 [CONTRACT]

### §5.1 エンドポイント一覧

全て Better Auth が提供するエンドポイント。カスタムエンドポイントは不要。

| メソッド | パス | 説明 | 認証 | 対象機能 |
|---------|------|------|------|---------|
| POST | `/api/auth/forget-password` | パスワードリセットメール送信 | 不要 | AUTH-006 |
| POST | `/api/auth/reset-password` | パスワード更新 | 不要（トークン認証） | AUTH-006 |
| GET | `/api/auth/verify-email` | メール認証コールバック | 不要（トークン認証） | AUTH-007 |
| POST | `/api/auth/send-verification-email` | 確認メール再送信 | 必要 | AUTH-007 |
| GET | `/api/auth/session` | 現在のセッション取得 | 必要（Cookie） | AUTH-009 |
| POST | `/api/auth/sign-out` | ログアウト（AUTH-005 で定義） | 必要（Cookie） | AUTH-009 |

### §5.2 POST /api/auth/forget-password（Better Auth 提供）

**リクエスト**:

```json
{
  "email": "user@example.com",
  "redirectTo": "/reset-password"
}
```

| フィールド | 型 | 必須 | バリデーション | 備考 |
|-----------|-----|------|--------------|------|
| email | string | MUST | メール形式、最大255文字 | |
| redirectTo | string | MAY | 同一オリジンの相対パス | リセットリンクのリダイレクト先 |

**レスポンス（成功）**: `200 OK`

```json
{
  "status": true
}
```

> 登録済み・未登録に関わらず同じレスポンスを返す（情報漏洩防止）。

**レスポンス（エラー）**:

| HTTPステータス | 条件 | エラーコード |
|--------------|------|-----------|
| 400 | バリデーションエラー（email が空/不正形式） | VALIDATION_ERROR |
| 429 | レート制限超過（同一メール 3回/時間） | RATE_LIMITED |
| 500 | メール送信失敗 | INTERNAL_ERROR |

### §5.3 POST /api/auth/reset-password（Better Auth 提供）

**リクエスト**:

```json
{
  "token": "reset_token_string",
  "newPassword": "NewSecurePass123!"
}
```

| フィールド | 型 | 必須 | バリデーション | 備考 |
|-----------|-----|------|--------------|------|
| token | string | MUST | 非空 | リセットメール内のトークン |
| newPassword | string | MUST | 8文字以上、128文字以下 | 新しいパスワード |

**レスポンス（成功）**: `200 OK`

```json
{
  "status": true
}
```

> 成功時、Better Auth は内部で以下を実行する:
> 1. パスワードハッシュを更新（bcrypt, cost=10）
> 2. 使用済みトークンを無効化
> 3. 全セッションを無効化（session テーブルの該当ユーザーレコード削除）

**レスポンス（エラー）**:

| HTTPステータス | 条件 | エラーコード |
|--------------|------|-----------|
| 400 | バリデーションエラー（newPassword が要件不足） | VALIDATION_ERROR |
| 400 | トークン期限切れ | TOKEN_EXPIRED |
| 400 | トークン使用済み | TOKEN_ALREADY_USED |
| 400 | トークン不正 | INVALID_TOKEN |

### §5.4 GET /api/auth/verify-email（Better Auth 提供）

**リクエスト**: クエリパラメータ

| パラメータ | 型 | 必須 | 備考 |
|-----------|-----|------|------|
| token | string | MUST | 確認メール内のトークン |

**レスポンス（成功）**: `302 Found`（/app にリダイレクト）

> 成功時、Better Auth は内部で user.emailVerified = true に更新する。

**レスポンス（エラー）**:

| HTTPステータス | 条件 | エラーコード |
|--------------|------|-----------|
| 400 | トークン期限切れ（24時間超過） | TOKEN_EXPIRED |
| 400 | トークン不正 | INVALID_TOKEN |

### §5.5 POST /api/auth/send-verification-email（Better Auth 提供）

**リクエスト**:

```json
{
  "email": "user@example.com"
}
```

| フィールド | 型 | 必須 | バリデーション | 備考 |
|-----------|-----|------|--------------|------|
| email | string | MUST | メール形式 | 再送信対象のメールアドレス |

**レスポンス（成功）**: `200 OK`

```json
{
  "status": true
}
```

**レスポンス（エラー）**:

| HTTPステータス | 条件 | エラーコード |
|--------------|------|-----------|
| 401 | 未認証（セッションなし） | UNAUTHORIZED |
| 429 | レート制限超過（同一メール 3回/時間） | RATE_LIMITED |

### §5.6 GET /api/auth/session（Better Auth 提供）

**リクエスト**: なし（Cookie セッションから自動取得）

**レスポンス（成功）**: `200 OK`

```json
{
  "user": {
    "id": "01HXYZ...",
    "email": "user@example.com",
    "name": "山田 太郎",
    "emailVerified": true,
    "image": null,
    "createdAt": "2026-02-09T10:00:00.000Z",
    "updatedAt": "2026-02-09T10:00:00.000Z"
  },
  "session": {
    "id": "session_01ABC...",
    "userId": "01HXYZ...",
    "expiresAt": "2026-02-16T10:00:00.000Z",
    "token": "...",
    "createdAt": "2026-02-09T10:00:00.000Z",
    "updatedAt": "2026-02-09T10:00:00.000Z"
  }
}
```

**レスポンス（エラー）**:

| HTTPステータス | 条件 | エラーコード |
|--------------|------|-----------|
| 401 | セッション無効/期限切れ/Cookie なし | UNAUTHORIZED |

---

## §6. データモデル [CONTRACT]

### §6.1 関連テーブル

| テーブル | 用途 | 管理 | 参照 |
|---------|------|------|------|
| user | ユーザー情報（emailVerified カラム含む） | Better Auth | SSOT-4 §2.2 |
| session | セッション管理（有効期限、トークン） | Better Auth | Better Auth 自動管理 |
| account | 認証アカウント（パスワードハッシュ） | Better Auth | Better Auth 自動管理 |
| verification | トークン管理（リセット・メール認証） | Better Auth | Better Auth 自動管理 |

### §6.2 Better Auth 管理テーブル: session

> Better Auth が自動的に作成・管理するテーブル。直接操作は禁止。

| カラム | 型 | NULL | 説明 |
|--------|-----|------|------|
| id | VARCHAR(36) | NO | PK（Better Auth が採番） |
| user_id | VARCHAR(36) | NO | FK → user.id |
| token | VARCHAR(255) | NO | セッショントークン（ハッシュ済み） |
| expires_at | TIMESTAMPTZ | NO | セッション有効期限 |
| ip_address | VARCHAR(45) | YES | クライアント IP |
| user_agent | TEXT | YES | ユーザーエージェント |
| created_at | TIMESTAMPTZ | NO | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | 更新日時 |

### §6.3 Better Auth 管理テーブル: verification

> Better Auth が自動的に作成・管理するテーブル。直接操作は禁止。

| カラム | 型 | NULL | 説明 |
|--------|-----|------|------|
| id | VARCHAR(36) | NO | PK |
| identifier | VARCHAR(255) | NO | 対象識別子（メールアドレス等） |
| value | TEXT | NO | トークン値（ハッシュ済み） |
| expires_at | TIMESTAMPTZ | NO | トークン有効期限 |
| created_at | TIMESTAMPTZ | NO | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | 更新日時 |

### §6.4 user テーブルの関連カラム

| カラム | 型 | 操作 | 対象機能 |
|--------|-----|------|---------|
| email_verified | BOOLEAN | UPDATE → true | AUTH-007 |

### §6.5 データ操作

| 操作 | テーブル | 条件/内容 | 対象機能 | 実行者 |
|------|---------|----------|---------|-------|
| INSERT | verification | リセットトークン発行 | AUTH-006 | Better Auth |
| SELECT | verification | WHERE identifier = :email AND expires_at > NOW() | AUTH-006 | Better Auth |
| DELETE | verification | 使用済みトークン削除 | AUTH-006 | Better Auth |
| UPDATE | account | SET password = :hashed_password | AUTH-006 | Better Auth |
| DELETE | session | WHERE user_id = :user_id（全セッション無効化） | AUTH-006 | Better Auth |
| INSERT | verification | 確認トークン発行 | AUTH-007 | Better Auth |
| UPDATE | user | SET email_verified = true | AUTH-007 | Better Auth |
| INSERT | session | セッション作成 | AUTH-009 | Better Auth |
| SELECT | session | WHERE user_id = :user_id ORDER BY created_at（セッション数カウント） | AUTH-009 | Better Auth |
| DELETE | session | WHERE id = :oldest_session_id（最古セッション削除） | AUTH-009 | Better Auth |
| UPDATE | session | SET expires_at = :new_expires_at, updated_at = NOW() | AUTH-010 | Better Auth |

> 全ての DB 操作は Better Auth が内部で管理する。アプリケーションコードから直接操作しないこと。

---

## §7. ビジネスロジック [CONTRACT]

### §7.1 AUTH-006: パスワードリセットフロー

```
1. ユーザーが /forgot-password でメールアドレスを入力

2. フロントエンドバリデーション
   ├─ email が空 → フィールドエラー「メールアドレスを入力してください」
   ├─ email が不正形式 → フィールドエラー「有効なメールアドレスを入力してください」
   └─ OK → 3へ

3. Better Auth forgetPassword() 呼び出し
   → Better Auth 内部で以下を実行:
   ├─ メールアドレスでユーザー検索
   ├─ ユーザーが見つからない → レスポンスは 200（情報漏洩防止）
   ├─ レート制限チェック（同一メール 3回/時間）
   │   └─ 超過 → 429 RATE_LIMITED
   ├─ リセットトークン生成（ランダム文字列）
   ├─ トークンをハッシュ化して verification テーブルに保存
   ├─ 有効期限: 1時間
   └─ sendResetPassword コールバックでメール送信

4. メール内のリンクをクリック → /reset-password?token=xxx

5. フロントエンドバリデーション
   ├─ newPassword が空 → フィールドエラー
   ├─ newPassword が8文字未満 → フィールドエラー
   ├─ confirmPassword と不一致 → フィールドエラー
   └─ OK → 6へ

6. Better Auth resetPassword() 呼び出し
   → Better Auth 内部で以下を実行:
   ├─ トークン検証（存在確認、有効期限、使用済みチェック）
   ├─ パスワードを bcrypt でハッシュ化
   ├─ account テーブルのパスワードを更新
   ├─ 使用済みトークンを削除
   └─ 全セッションを無効化（session テーブルから該当ユーザーの全レコード削除）

7. フロントエンドで /login にリダイレクト
   + 「パスワードが更新されました」トースト表示
```

### §7.2 AUTH-007: メール認証フロー

```
1. サインアップ時
   → Better Auth がサインアップ処理後に自動でメール送信
   → sendVerificationEmail コールバックが呼ばれる
   → 確認トークン生成（有効期限: 24時間）
   → verification テーブルにハッシュ化して保存

2. メール内のリンクをクリック
   → GET /api/auth/verify-email?token=xxx
   → Better Auth 内部で以下を実行:
   ├─ トークン検証（存在確認、有効期限）
   ├─ user.emailVerified = true に更新
   └─ リダイレクト

3. リダイレクト先
   ├─ ログイン済み → /app + 「メールアドレスが確認されました」トースト
   └─ 未ログイン → /login + 「メールアドレスが確認されました。ログインしてください」メッセージ

4. 確認メール再送信
   → POST /api/auth/send-verification-email
   → 新しいトークン発行（古いトークンは無効化）
   → レート制限: 同一メール 3回/時間
```

### §7.3 AUTH-007: 未確認ユーザーの制限

```
メール未確認のユーザー（emailVerified = false）に対する制限:
- ダッシュボード上部に警告バナー「メールアドレスを確認してください」表示
- バナーに「確認メールを再送信」リンクを配置
- 基本機能は全て利用可能（MVP では制限なし）
- メール通知の送信は制限（確認後に有効化）

実装方法:
- composables/useAuth.ts で user.emailVerified を参照
- layouts/dashboard.vue で条件付きバナー表示
```

### §7.4 AUTH-009: セッション管理ロジック

```
1. セッション作成
   → ログイン成功時に Better Auth が session テーブルにレコード作成
   → expiresIn に応じた有効期限を設定
     ├─ rememberMe=false → 7日（604800秒）
     └─ rememberMe=true → 30日（2592000秒）
   → Cookie に以下の設定でセッショントークンをセット:
     ├─ HttpOnly: true
     ├─ Secure: true（HTTPS 必須）
     ├─ SameSite: Lax
     ├─ Path: /
     └─ Max-Age: expiresIn の値

2. 同時セッション制限
   → ログイン時に Better Auth が session テーブルで同一ユーザーのセッション数をカウント
   ├─ 3以下 → 新しいセッションを追加
   └─ 3を超える → 最古のセッション（created_at が最も古いもの）を削除してから新規作成

3. セッション検証
   → 各リクエストで Cookie のセッショントークンを検証
   ├─ 有効 → リクエスト処理を続行
   └─ 無効（期限切れ、削除済み、不正） → 401 UNAUTHORIZED

4. Cookie キャッシュ
   → cookieCache: { enabled: true, maxAge: 300 }
   → クライアント側で5分間セッション情報をキャッシュ
   → キャッシュ期間中は /api/auth/session への問い合わせをスキップ
```

### §7.5 AUTH-010: セッション自動更新ロジック

```
1. Better Auth のリクエスト処理時
   → session.updated_at と現在時刻を比較
   ├─ 差分 < updateAge（24時間） → 何もしない
   └─ 差分 >= updateAge（24時間） → 2へ

2. セッション更新
   → session.expires_at を現在時刻 + expiresIn に更新
   → session.updated_at を現在時刻に更新
   → Set-Cookie ヘッダーで Cookie の有効期限も更新
   → これらはバックグラウンドで実行され、レスポンスに影響しない
```

### §7.6 セキュリティ要件

| 要件 | 実装 | 対象機能 |
|------|------|---------|
| リセットトークンのハッシュ化保存 | Better Auth 内部（verification テーブル） | AUTH-006 |
| リセットトークンの単一使用 | 使用後に verification レコード削除 | AUTH-006 |
| リセット後の全セッション無効化 | session テーブルの該当ユーザー全レコード削除 | AUTH-006 |
| レート制限（リセットメール） | 同一メール 3回/時間 | AUTH-006 |
| 情報漏洩防止 | 未登録メールでも同じ成功レスポンス | AUTH-006 |
| 確認トークンのハッシュ化保存 | Better Auth 内部（verification テーブル） | AUTH-007 |
| Cookie セキュリティ | HttpOnly, Secure, SameSite=Lax | AUTH-009 |
| 同時セッション制限 | 最大3セッション（超過時は最古を無効化） | AUTH-009 |
| セッショントークンのハッシュ化 | Better Auth 内部で保存前にハッシュ化 | AUTH-009 |

---

## §8. エラーハンドリング [CONTRACT]

### §8.1 フロントエンド

#### AUTH-006: パスワードリセット

| エラー種別 | 表示方法 | メッセージ |
|-----------|---------|-----------|
| フィールドバリデーション | フィールド直下（UFormGroup error） | バリデーションメッセージ |
| トークン期限切れ | フォーム上部 UAlert (color="error") + 再リクエストリンク | 「リセットリンクの有効期限が切れています。再度リセットをリクエストしてください」 |
| トークン使用済み | フォーム上部 UAlert (color="error") + 再リクエストリンク | 「このリセットリンクは既に使用されています」 |
| トークン不正 | フォーム上部 UAlert (color="error") + 再リクエストリンク | 「無効なリセットリンクです」 |
| レート制限 | フォーム上部 UAlert (color="warning") | 「しばらく時間をおいてから再試行してください」 |
| メール送信失敗 | フォーム上部 UAlert (color="error") | 「メールの送信に失敗しました。再試行してください」 |
| ネットワークエラー | フォーム上部 UAlert (color="error") | 「通信エラーが発生しました。再試行してください」 |
| サーバーエラー | フォーム上部 UAlert (color="error") | 「システムエラーが発生しました。しばらく経ってから再試行してください」 |

#### AUTH-007: メール認証

| エラー種別 | 表示方法 | メッセージ |
|-----------|---------|-----------|
| トークン期限切れ | エラーページ + 再送信ボタン | 「確認リンクの有効期限が切れています。再送信してください」 |
| トークン不正 | エラーページ | 「無効な確認リンクです」 |
| 再送信レート制限 | トースト (color="warning") | 「しばらく時間をおいてから再送信してください」 |
| 再送信成功 | トースト (color="success") | 「確認メールを送信しました」 |

#### AUTH-009/010: セッション

| エラー種別 | 表示方法 | メッセージ |
|-----------|---------|-----------|
| セッション期限切れ | /login にリダイレクト + トースト | 「セッションの有効期限が切れました。再度ログインしてください」 |
| セッション無効化（他デバイスログインにより） | /login にリダイレクト + トースト | 「別のデバイスでログインしたため、このセッションは終了しました」 |
| 不正な Cookie | /login にリダイレクト（メッセージなし） | - |

### §8.2 バックエンド

| エラー種別 | HTTPステータス | ログレベル | ログ内容 |
|-----------|--------------|-----------|---------|
| リセットメール送信 | 200 | INFO | email(masked), ip |
| リセットメール送信失敗 | 500 | ERROR | email(masked), error_detail |
| リセットトークン検証失敗 | 400 | INFO | token_type(expired/used/invalid), ip |
| パスワード更新成功 | 200 | INFO | user_id(masked), sessions_invalidated_count |
| メール認証成功 | 302 | INFO | user_id(masked) |
| メール認証失敗 | 400 | INFO | token_type, ip |
| セッション期限切れ | 401 | DEBUG | session_id(masked) |
| セッション強制無効化 | - | INFO | user_id(masked), invalidated_session_id(masked), reason(concurrent_limit) |
| レート制限超過 | 429 | WARN | email(masked), ip, request_count |

---

## §9. テスト仕様 [DETAIL]

### §9.1 ユニットテスト

| テストID | テストケース | 入力 | 期待結果 |
|----------|-------------|------|---------|
| TC-001 | forgot-password バリデーション（空メール） | email="" | 400 VALIDATION_ERROR |
| TC-002 | forgot-password バリデーション（不正形式） | email="invalid" | 400 VALIDATION_ERROR |
| TC-003 | reset-password バリデーション（パスワード8文字未満） | newPassword="short" | 400 VALIDATION_ERROR |
| TC-004 | reset-password バリデーション（パスワード空） | newPassword="" | 400 VALIDATION_ERROR |
| TC-005 | reset-password バリデーション（確認パスワード不一致） | newPassword="Pass123!", confirm="Other456!" | 400 VALIDATION_ERROR |
| TC-006 | reset-password バリデーション（パスワード128文字） | newPassword="a".repeat(128) | OK（境界値） |
| TC-007 | reset-password バリデーション（パスワード129文字超） | newPassword="a".repeat(129) | 400 VALIDATION_ERROR |
| TC-008 | メール未確認バナー表示判定（未確認） | emailVerified=false | バナー表示 |
| TC-009 | メール未確認バナー表示判定（確認済み） | emailVerified=true | バナー非表示 |

### §9.2 統合テスト

| テストID | テストケース | 手順 | 期待結果 |
|----------|-------------|------|---------|
| TC-101 | パスワードリセットフロー完了 | forget-password → メール受信 → reset-password | パスワード更新成功 |
| TC-102 | リセットトークン期限切れ | 1時間超過後にリセット実行 | 400 TOKEN_EXPIRED |
| TC-103 | リセットトークン使用済み | 同じトークンで2回リセット実行 | 2回目は 400 TOKEN_ALREADY_USED |
| TC-104 | リセット後の全セッション無効化 | パスワード更新後に既存セッションで API 呼び出し | 401 UNAUTHORIZED |
| TC-105 | リセットメール レート制限 | 1時間以内に4回送信 | 4回目で 429 |
| TC-106 | 未登録メールへのリセットリクエスト | 存在しないメールで送信 | 200（情報漏洩防止） |
| TC-107 | メール認証フロー完了 | verify-email?token=valid | emailVerified = true |
| TC-108 | 確認トークン期限切れ | 24時間超過後にメール認証 | 400 TOKEN_EXPIRED |
| TC-109 | 確認メール再送信 | send-verification-email | メール送信成功 |
| TC-110 | セッション有効期限（7日） | rememberMe=false でログイン → 7日後にアクセス | 401 セッション切れ |
| TC-111 | セッション有効期限（30日） | rememberMe=true でログイン → 7日後にアクセス | 有効（30日以内） |
| TC-112 | Cookie セキュリティ属性 | ログイン成功 | HttpOnly, Secure, SameSite=Lax の Cookie |
| TC-113 | 同時セッション制限（3以下） | 3台でログイン | 全セッション有効 |
| TC-114 | 同時セッション超過（4台目） | 4台目でログイン | 最古セッション無効化 |
| TC-115 | セッション自動延長 | 24時間経過後にリクエスト | expires_at が更新される |
| TC-116 | セッション更新なし（24時間未満） | 12時間後にリクエスト | expires_at は変更なし |
| TC-117 | 期限切れセッションでアクセス | expires_at 超過後にリクエスト | 401 UNAUTHORIZED |

### §9.3 E2Eテスト

| テストID | テストケース | 手順 | 期待結果 |
|----------|-------------|------|---------|
| TC-201 | パスワードリセット申請フロー | /forgot-password → メール入力 → 送信 | 成功メッセージ表示 |
| TC-202 | パスワードリセット実行フロー | /reset-password?token=xxx → 新パスワード入力 → 送信 | /login にリダイレクト + トースト |
| TC-203 | 無効トークンでリセット画面 | /reset-password?token=invalid | エラーバナー + 再リクエストリンク |
| TC-204 | メール未確認バナー表示 | 未確認ユーザーでログイン | ダッシュボードにバナー表示 |
| TC-205 | 確認メール再送信 | バナーの再送信リンクをクリック | トースト「確認メールを送信しました」 |
| TC-206 | セッション期限切れ後のリダイレクト | 期限切れ後に Protected ページアクセス | /login にリダイレクト |
| TC-207 | パスワードリセット申請のローディング状態 | 送信ボタンクリック | ボタン無効化 + loading 表示 |
| TC-208 | パスワードリセットの入力バリデーション | 不正な値を入力 | フィールドエラー表示 |

---

## §10. 非機能要件 [CONTRACT]

### §10.1 パフォーマンス

| 指標 | 目標値 | 対象機能 |
|------|-------|---------|
| forget-password API 応答時間（p95） | < 1秒 | AUTH-006 |
| reset-password API 応答時間（p95） | < 500ms | AUTH-006 |
| verify-email API 応答時間（p95） | < 500ms | AUTH-007 |
| session API 応答時間（p95） | < 100ms | AUTH-009 |
| セッション更新処理（p95） | < 50ms（バックグラウンド） | AUTH-010 |
| ページ読み込み（LCP、auth レイアウト） | < 2.5秒 | AUTH-006 |
| メール送信完了 | < 30秒 | AUTH-006, AUTH-007 |

### §10.2 可用性

| 指標 | 目標値 |
|------|-------|
| 稼働率 | 99.9% |

### §10.3 セキュリティ

| 項目 | 対応 | 対象機能 |
|------|------|---------|
| HTTPS | MUST | 全機能 |
| トークンのハッシュ化保存 | Better Auth 内部（verification テーブル） | AUTH-006, AUTH-007 |
| トークン単一使用 | 使用後に削除 | AUTH-006 |
| 有効期限 | リセット: 1時間、認証: 24時間 | AUTH-006, AUTH-007 |
| レート制限 | 同一メール 3回/時間 | AUTH-006, AUTH-007 |
| 情報漏洩防止 | 未登録メールでも同じレスポンス | AUTH-006 |
| Cookie セキュリティ | HttpOnly, Secure, SameSite=Lax | AUTH-009 |
| セッション数制限 | 最大3（超過時は最古を無効化） | AUTH-009 |
| パスワードハッシュ化 | bcrypt (cost=10, Better Auth デフォルト) | AUTH-006 |

---

## §11. 依存関係 [CORE]

### §11.1 前提となる機能

| 機能ID | 機能名 | 依存内容 |
|--------|-------|---------|
| AUTH-001 | ログイン | セッション Cookie 基盤、Better Auth セットアップ |

### §11.2 この機能に依存する機能

| 機能ID | 機能名 | 依存内容 |
|--------|-------|---------|
| AUTH-001 | ログイン | セッション管理（AUTH-009）、セッション自動更新（AUTH-010） |
| AUTH-005 | ログアウト | セッション管理（AUTH-009）によるセッション無効化 |
| ACCT-001 | サインアップ | メール認証（AUTH-007）のトリガー |
| ACCT-002 | プロフィール閲覧 | メール認証状態の表示 |

---

## §12. 未決定事項・制約 [DETAIL]

### §12.1 未決定事項（TBD）

| # | 項目 | 層 | 理由 | デフォルト案 |
|---|------|-----|------|------------|
| - | - | - | 全て決定済み | - |

> CORE層・CONTRACT層のTBDはゼロ。DETAIL層のTBDもゼロ。

### §12.2 前提条件

- Better Auth v1.4+ がインストール済み
- PostgreSQL 16 が稼働中
- BETTER_AUTH_SECRET 環境変数が設定済み
- SMTP メール送信設定が完了している（SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS）
- Better Auth の管理テーブル（session, verification, account）が自動マイグレーション済み

### §12.3 制約事項

- Better Auth の管理テーブル（session, verification, account）は直接 SQL 操作しない
- パスワードハッシュは Better Auth 内部の bcrypt（cost=10）に委譲
- リセットトークン・確認トークンの生成ロジックは Better Auth に委譲
- セッション管理のロジック（同時セッション制限含む）は Better Auth に委譲
- メール認証は必須ではない（未確認でもログイン・操作可能）
- メール未確認ユーザーへの機能制限は MVP ではバナー表示のみ
- セッション Cookie は HttpOnly, Secure, SameSite=Lax（Better Auth デフォルト、変更不可）

---

## 実装メモ（AI向け）

### Better Auth 設定（server/utils/auth.ts）

```typescript
import { betterAuth } from 'better-auth';
import { organization } from 'better-auth/plugins';
import { drizzleAdapter } from 'better-auth/adapters/drizzle';

export const auth = betterAuth({
  database: drizzleAdapter(db, { provider: 'pg' }),

  // メール/パスワード認証
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: false, // 未確認でもログイン可能
    sendResetPassword: async ({ user, url }) => {
      await sendEmail({
        to: user.email,
        subject: 'パスワードリセット - Haishin+ HUB',
        html: renderResetPasswordEmail(url),
      });
    },
  },

  // メール認証
  emailVerification: {
    sendVerificationEmail: async ({ user, url }) => {
      await sendEmail({
        to: user.email,
        subject: 'メールアドレスの確認 - Haishin+ HUB',
        html: renderVerificationEmail(url),
      });
    },
    sendOnSignUp: true,
    autoSignInAfterVerification: true,
  },

  // セッション設定
  session: {
    expiresIn: 60 * 60 * 24 * 7,        // デフォルト: 7日
    updateAge: 60 * 60 * 24,             // 1日ごとにセッション更新
    cookieCache: {
      enabled: true,
      maxAge: 60 * 5,                    // 5分間キャッシュ
    },
  },

  // OAuth
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    },
  },

  // プラグイン
  plugins: [organization()],
});
```

### Catch-all ハンドラ（server/api/auth/[...all].ts）

```typescript
import { auth } from '~/server/utils/auth';
import { toNodeHandler } from 'better-auth/node';

export default defineEventHandler(toNodeHandler(auth));
```

### 実装順序

```
1. Better Auth 設定
   - server/utils/auth.ts に emailAndPassword, emailVerification, session 設定を追加
   - メール送信関数（sendEmail）の実装
   - メールテンプレート（リセット用、認証用）の作成

2. UI ページ
   - pages/forgot-password.vue — auth レイアウト使用
   - pages/reset-password.vue — auth レイアウト使用
   - components/features/auth/EmailVerificationBanner.vue — メール未確認バナー

3. Composable
   - composables/useAuth.ts に forgetPassword(), resetPassword(), resendVerificationEmail() を追加

4. レイアウト
   - layouts/dashboard.vue に EmailVerificationBanner を条件付き表示

5. テスト
   - 統合テスト（Better Auth + DB）
   - E2Eテスト（リセットフロー、バナー表示）
```

### 参照すべきファイル

| 種類 | ファイル | 参照内容 |
|------|---------|---------|
| 認証共通 | SSOT-5_CROSS_CUTTING.md §1 | Better Auth 設定、セッション管理 |
| API共通 | SSOT-3_API_CONTRACT.md §2.1 | Better Auth エンドポイント |
| DB共通 | SSOT-4_DATA_MODEL.md §2.2 | user テーブル（emailVerified カラム） |
| UI共通 | SSOT-2_UI_STATE.md | 認証状態定義 |
| ログイン | AUTH-001_login.md | セッション設定、Cookie 仕様の参照 |
| ログアウト | AUTH-005_logout.md | セッション無効化処理の参照 |
| サインアップ | ACCT-001_signup.md | メール認証トリガーの参照 |

### 注意事項

- Better Auth の管理テーブル（session, verification, account）は直接操作しない
- パスワードは絶対にログに出力しない
- メールアドレスはログ出力時にマスク（`u***@example.com`）
- リセットメールの送信結果に関わらず、ユーザーには同じ成功メッセージを返す（情報漏洩防止）
- セッション関連のカスタムコードは不要（Better Auth の設定値のみで実現）
- 同時セッション制限は Better Auth のプラグインまたはフック機能で実現

---

## カスタマイズ差分（テンプレートとの差異）

| セクション | 変更内容 | 理由 |
|-----------|---------|------|
| 全体構造 | SSOT 12セクション形式に変更（§1-§12 + [CORE]/[CONTRACT]/[DETAIL] タグ） | Gold Standard 準拠 |
| §2 | 機能別に AC を整理、§2.4-2.7（入出力例・境界値・例外レスポンス・Gherkin）を追加 | DETAIL 層完備 |
| §3 UI | 画面レイアウト・要素詳細・状態別表示を追加 | 実装可能な詳細度 |
| §4 状態遷移 | 機能別の状態遷移図・遷移ルールテーブルを追加 | 実装ガイド |
| §5 API | Better Auth エンドポイントの詳細（リクエスト/レスポンス形式）を追加 | API 仕様の明確化 |
| §6 データモデル | Better Auth 管理テーブル（session, verification）の構造を明記 | 参照用 |
| §7 ビジネスロジック | 各機能の詳細フローを追加 | 実装ガイド |
| §8 エラーハンドリング | 機能別のフロント/バックエンドエラーハンドリングを追加 | 網羅的なエラー対応 |
| §9 テスト | ユニット9件 + 統合17件 + E2E 8件 に拡充 | テストカバレッジ向上 |
| §10 非機能要件 | 機能別パフォーマンス目標を追加 | 計測可能な指標 |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|----------|---------|-------|
| 2026-02-09 | v1.0 | 初版作成（Better Auth 標準機能として統合） | AI |
| 2026-02-09 | v2.0 | 完全書き直し: SSOT 12セクション形式 + [CORE]/[CONTRACT]/[DETAIL] タグ + §2.4-2.7（入出力例15件・境界値12項目・例外レスポンス15件・Gherkin 28シナリオ）+ 詳細 UI/状態遷移/API/テスト仕様。Gold Standard化 | AI |

---

## 承認

| 役割 | 名前 | 日付 | 承認 |
|------|------|------|------|
| 設計者 | | | ☐ |
| テックリード | | | ☐ |
| プロダクトオーナー | | | ☐ |
