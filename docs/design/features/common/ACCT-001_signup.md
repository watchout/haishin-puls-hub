# ACCT-001: サインアップ機能

## メタ情報

| 項目 | 内容 |
|------|------|
| 機能ID | ACCT-001 |
| 機能名 | サインアップ機能 |
| カテゴリ | アカウント |
| 優先度 | P0 |
| ステータス | Approved |
| 作成日 | 2026-02-09 |
| 最終更新日 | 2026-02-09 |
| ベース | common-features/account/ACCT-001_signup.md |

---

## 1. 概要

### 1.1 機能の目的

新規ユーザーが招待リンクまたはセルフ登録でアカウントを作成し、サービスを利用開始できるようにする機能。Google OAuth でのサインアップにも対応する。

### 1.2 ユーザーストーリー

```
As a 新規ユーザー（招待を受けた人 or セルフ登録者）,
I want to アカウントを作成したい,
so that Haishin+ HUB でイベント運営に参加できる.
```

### 1.3 スコープ

**In Scope**:
- 招待ベースのサインアップ（招待リンク → 登録フォーム、テナント・ロール自動設定）
- セルフ登録（/signup から直接登録、テナント・ロールは後で管理者が設定）
- Google OAuth でのサインアップ
- ユーザー情報の入力・バリデーション
- 確認メールの送信（Better Auth 標準）
- サインアップ後の自動ログイン

**Out of Scope**:
- 管理者によるユーザー直接作成（OPS-002 で対応）
- Microsoft OAuth（Phase 2）
- 電話番号認証

---

## 2. 受入条件（Acceptance Criteria）

### 2.1 正常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-001 | 招待リンクからアクセスした場合、招待情報（テナント名・ロール）がフォーム上部に表示される | E2Eテスト |
| AC-002 | 有効な情報を入力してサインアップすると、アカウントが作成される | ユニットテスト |
| AC-003 | サインアップ成功後、確認メールが送信される | 統合テスト |
| AC-004 | サインアップ成功後、自動的にログイン状態になる | E2Eテスト |
| AC-005 | 招待ベースの場合、サインアップ後にロール別リダイレクト先に遷移する | E2Eテスト |
| AC-006 | セルフ登録の場合、サインアップ後にオンボーディング画面に遷移する | E2Eテスト |
| AC-007 | Google OAuth でサインアップできる | E2Eテスト |
| AC-008 | 招待リンク + Google OAuth の場合、テナント・ロールが自動設定される | 統合テスト |

### 2.2 異常系

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-101 | 既に登録済みのメールアドレスの場合、「このメールアドレスは既に使用されています」エラー | ユニットテスト |
| AC-102 | メールアドレスが不正な形式の場合、エラー表示 | ユニットテスト |
| AC-103 | パスワードが8文字未満の場合、エラー表示 | ユニットテスト |
| AC-104 | パスワードと確認用パスワードが一致しない場合、エラー表示 | ユニットテスト |
| AC-105 | 名前が空の場合、エラー表示 | ユニットテスト |
| AC-106 | 利用規約に同意していない場合、エラー表示 | ユニットテスト |
| AC-107 | 招待リンクが無効（期限切れ or 使用済み）の場合、エラーページ表示 | E2Eテスト |

### 2.3 エッジケース

| # | 条件 | 検証方法 |
|---|------|---------|
| AC-201 | メール送信に失敗してもアカウントは作成される（後で再送可能） | 統合テスト |
| AC-202 | 同時に同じメールアドレスでサインアップしようとした場合、1つだけ成功する | 統合テスト |
| AC-203 | Google OAuth で既存メールアドレスと一致する場合、既存アカウントにリンク | 統合テスト |

### 2.4 入出力例（§3-E） [DETAIL]

| # | 入力 | 条件 | 期待出力 | 備考 |
|---|------|------|---------|------|
| 1 | name: "山田太郎", password: "Valid123!", token: 有効 | 招待ベース正常 | 201, user + user_tenant 作成, Set-Cookie | テナント・ロールは招待から取得 |
| 2 | name: "田中花子", email: "tanaka@ex.com", password: "Pass456!" | セルフ登録正常 | 200, user 作成, Set-Cookie, 確認メール送信 | user_tenant なし、/app/onboarding 遷移 |
| 3 | token: 有効 + Google 認証 | Google OAuth（招待あり） | 201, user + account + user_tenant 作成 | テナント・ロール自動設定 |
| 4 | Google 認証のみ（token なし） | Google OAuth（セルフ） | 200, user 作成, /app/onboarding 遷移 | user_tenant なし |
| 5 | email: "existing@ex.com" | メール重複 | 409, "このメールアドレスは既に登録されています" | ログイン画面へ誘導 |
| 6 | password: "abc" | パスワード短すぎ（8文字未満） | 400, "パスワードは8文字以上で入力してください" | フロントエンド Zod バリデーション |
| 7 | password: "Pass1", password_confirm: "Pass2" | パスワード不一致 | 400, フィールドエラー「パスワードが一致しません」 | フロントエンド Zod |
| 8 | name: "" | 名前が空 | 400, "名前を入力してください" | フロントエンド Zod |
| 9 | terms_accepted: false | 利用規約未同意 | 400, "利用規約に同意してください" | フロントエンド Zod |
| 10 | token: "invalid" | 招待トークン無効 | 404, "招待リンクが無効です" | エラーページ表示 |
| 11 | token: expired（7日超過） | 招待トークン期限切れ | 410, "招待リンクの有効期限が切れています" | 再招待依頼リンク表示 |
| 12 | token: used（accepted 済み） | 招待トークン使用済み | 409, "この招待リンクは既に使用されています" | ログイン画面へ誘導 |

### 2.5 境界値（§3-F） [DETAIL]

| 項目 | 最小値 | 最大値 | 空 | NULL | 不正形式 |
|------|--------|--------|-----|------|---------|
| name | 1文字 → OK | 100文字 → OK | "" → VAL: "名前を入力してください" | undefined → VAL: "名前を入力してください" | - (文字列なら全て許可) |
| name (101文字超) | - | 101文字 → 400 (Zod maxLength) | - | - | - |
| email | "a@b.co" (6文字) → OK | 255文字 → OK | "" → VAL: "メールアドレスを入力してください" | undefined → VAL: "メールアドレスを入力してください" | "abc" → VAL: "有効なメールアドレスを入力してください" |
| email (256文字超) | - | 256文字 → 400 (Zod maxLength) | - | - | - |
| password | 8文字 → OK | 128文字 → OK | "" → VAL: "パスワードを入力してください" | undefined → VAL: "パスワードを入力してください" | - (文字列なら全て許可、サーバー側で bcrypt 処理) |
| password (範囲外) | 7文字 → 400 "パスワードは8文字以上で入力してください" | 129文字 → 400 (Zod maxLength) | - | - | - |
| password_confirm | パスワードと一致 → OK | - | "" → VAL: "パスワード（確認）を入力してください" | undefined → VAL | パスワードと不一致 → 400 "パスワードが一致しません" |
| terms_accepted | true → OK | - | undefined → 400 "利用規約に同意してください" | null → 400 | false → 400 "利用規約に同意してください" |
| invitation token | 有効（32バイト hex）→ OK | - | 空（パラメータなし）→ セルフ登録扱い | - | 改ざん値 → 404 "招待リンクが無効です" |
| invitation 有効期限 | 6日23時間59分 → OK | 7日0分0秒 → OK（境界） | - | - | 7日0分1秒 → 410 期限切れ |

### 2.6 例外レスポンス（§3-G） [DETAIL]

| # | 例外条件 | HTTPステータス | エラーコード | ユーザーメッセージ | リトライ可否 | 復旧方法 |
|---|---------|---------------|------------|-----------------|------------|---------|
| 1 | バリデーションエラー | 400 | VALIDATION_ERROR | （各フィールドのバリデーションメッセージ） | Yes | 再入力 |
| 2 | メールアドレス重複 | 409 | CONFLICT | このメールアドレスは既に登録されています | No | ログイン画面へ |
| 3 | 招待トークン無効 | 404 | INVITATION_NOT_FOUND | 招待リンクが無効です | No | 管理者に再招待依頼 |
| 4 | 招待トークン期限切れ | 410 | INVITATION_EXPIRED | 招待リンクの有効期限が切れています。管理者に再招待をご依頼ください | No | 管理者に再招待依頼 |
| 5 | 招待トークン使用済み | 409 | INVITATION_ALREADY_USED | この招待リンクは既に使用されています | No | ログイン画面へ |
| 6 | レート制限超過 | 429 | RATE_LIMITED | しばらく時間をおいて再試行してください | Yes (60s) | 時間経過 |
| 7 | Google OAuth キャンセル | - (redirect) | OAUTH_CANCELLED | Google サインアップがキャンセルされました | Yes | 再試行 |
| 8 | Google OAuth メール重複 | 409 | OAUTH_EMAIL_CONFLICT | このメールアドレスは既に別の方法で登録されています | No | 既存方法でログイン |
| 9 | ネットワークエラー | - (fetch失敗) | NETWORK_ERROR | 通信エラーが発生しました。再試行してください | Yes | 再試行 |
| 10 | サーバーエラー | 500 | INTERNAL_ERROR | システムエラーが発生しました | Yes | 自動復旧待ち |
| 11 | メール送信失敗 | - (内部) | MAIL_SEND_FAILED | （ユーザーに表示しない、アカウントは作成済み） | - | 後で再送可能 |

### 2.7 受け入れテスト（§3-H Gherkin） [DETAIL]

```gherkin
Feature: ACCT-001 サインアップ機能

  Background:
    Given サインアップ画面 /signup が表示されている
    And Better Auth がセットアップ済み
    And メール送信サービスが稼働中

  Scenario: 招待ベース正常サインアップ
    Given 有効な招待トークン token が存在する
    And 招待のテナントが "ビジョンセンター"、ロールが "venue_staff"
    When /signup?token=:token にアクセスする
    Then 招待情報バナーに "ビジョンセンター" と "会場スタッフ" が表示される
    And メールアドレスがプリフィルされ編集不可である
    When name "山田太郎" と password "Valid123!" を入力する
    And 利用規約に同意する
    And "アカウントを作成" ボタンをクリックする
    Then ステータスコード 201 が返される
    And user レコードが作成される
    And user_tenant レコードが tenant "ビジョンセンター"、role "venue_staff" で作成される
    And セッション Cookie がセットされる
    And ロール別リダイレクト先に遷移する

  Scenario: セルフ登録正常サインアップ
    When /signup にアクセスする（トークンなし）
    And name "田中花子"、email "tanaka@example.com"、password "Pass456!" を入力する
    And 利用規約に同意する
    And "アカウントを作成" ボタンをクリックする
    Then ステータスコード 200 が返される
    And user レコードが作成される
    And user_tenant レコードは作成されない
    And セッション Cookie がセットされる
    And 確認メールが送信される
    And /app/onboarding に遷移する

  Scenario: Google OAuth サインアップ（招待あり）
    Given 有効な招待トークン token が存在する
    When /signup?token=:token にアクセスする
    And "Google で登録" ボタンをクリックする
    And Google で認証を完了する
    Then ステータスコード 201 が返される
    And user レコードが作成される
    And account レコードが provider "google" で作成される
    And user_tenant レコードが招待の情報で作成される
    And セッション Cookie がセットされる
    And ロール別リダイレクト先に遷移する

  Scenario: Google OAuth サインアップ（セルフ）
    When /signup にアクセスする（トークンなし）
    And "Google で登録" ボタンをクリックする
    And Google で認証を完了する
    Then ステータスコード 200 が返される
    And user レコードが作成される
    And account レコードが provider "google" で作成される
    And user_tenant レコードは作成されない
    And /app/onboarding に遷移する

  Scenario: メールアドレス重複
    Given email "existing@example.com" のユーザーが既に登録済み
    When name "テスト"、email "existing@example.com"、password "Valid123!" を入力する
    And 利用規約に同意する
    And "アカウントを作成" ボタンをクリックする
    Then ステータスコード 409 が返される
    And エラーメッセージ "このメールアドレスは既に登録されています" が表示される

  Scenario: パスワードバリデーション（8文字未満）
    When name "テスト"、email "test@example.com"、password "abc" を入力する
    And "アカウントを作成" ボタンをクリックする
    Then フィールドエラー "パスワードは8文字以上で入力してください" が表示される
    And API は呼び出されない

  Scenario: パスワード確認不一致
    When password "Valid123!" と password_confirm "Different!" を入力する
    And "アカウントを作成" ボタンをクリックする
    Then フィールドエラー "パスワードが一致しません" が表示される
    And API は呼び出されない

  Scenario: 名前が空
    When name を空のまま email と password を入力する
    And "アカウントを作成" ボタンをクリックする
    Then フィールドエラー "名前を入力してください" が表示される
    And API は呼び出されない

  Scenario: 利用規約未同意
    When name、email、password を入力する
    And 利用規約のチェックボックスを未チェックのまま
    And "アカウントを作成" ボタンをクリックする
    Then フィールドエラー "利用規約に同意してください" が表示される
    And API は呼び出されない

  Scenario: 招待トークン無効
    When /signup?token=invalid_token にアクセスする
    Then エラーページが表示される
    And エラーメッセージ "招待リンクが無効です" が表示される
    And サインアップフォームは表示されない

  Scenario: 招待トークン期限切れ
    Given 有効期限が切れた招待トークン expired_token が存在する
    When /signup?token=expired_token にアクセスする
    Then エラーページが表示される
    And エラーメッセージ "招待リンクの有効期限が切れています" が表示される
    And "管理者に再招待をご依頼ください" のガイダンスが表示される

  Scenario: メール送信失敗でもアカウント作成成功
    Given メール送信サービスが一時的にダウンしている
    When セルフ登録で正常な情報を入力してサインアップする
    Then user レコードが作成される
    And セッション Cookie がセットされる
    And /app/onboarding に遷移する
    And メール送信失敗が WARN レベルでログ記録される

  Scenario: 同時に同じメールアドレスでサインアップ（排他制御）
    Given 2つのブラウザセッションで同時に email "race@example.com" でサインアップする
    Then 1つだけが成功する
    And もう1つは 409 CONFLICT エラーになる

  Scenario: Google OAuth で既存メールアドレスのアカウントにリンク
    Given email "existing@example.com" のユーザーがパスワード認証で登録済み
    When Google OAuth で同じメールアドレス "existing@example.com" でサインアップする
    Then 既存の user レコードに account レコードが追加される
    And 新しい user レコードは作成されない
    And セッション Cookie がセットされる
```

---

## 3. UI仕様

### 3.1 画面一覧

| Screen ID | 画面名 | パス | 認証 | レイアウト |
|-----------|-------|------|------|----------|
| SCR-SIGNUP | サインアップ画面 | /signup | 不要 | auth |
| SCR-SIGNUP-INVITE | 招待サインアップ | /signup?token=xxx | 不要 | auth |

### 3.2 画面レイアウト

```
┌──────────────────────────────────────────────────┐
│                   [ロゴ]                          │
│              Haishin+ HUB                         │
│                                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │ 📩 「ビジョンセンター」から招待されています    │  │
│  │ ロール: 会場スタッフ                          │  │
│  └─────────────────────────────────────────────┘  │
│  ↑ 招待リンク経由の場合のみ表示                     │
│                                                   │
│   ┌─────────────────────────────────────────┐     │
│   │  エラーメッセージバナー（エラー時のみ）     │     │
│   └─────────────────────────────────────────┘     │
│                                                   │
│   名前 *                                          │
│   ┌─────────────────────────────────────────┐     │
│   │ 山田 太郎                                │     │
│   └─────────────────────────────────────────┘     │
│                                                   │
│   メールアドレス *                                 │
│   ┌─────────────────────────────────────────┐     │
│   │ example@email.com                        │     │
│   └─────────────────────────────────────────┘     │
│                                                   │
│   パスワード *                                     │
│   ┌─────────────────────────────────────────┐     │
│   │ ••••••••                           [👁]  │     │
│   └─────────────────────────────────────────┘     │
│   [強度インジケーター: ████████░░ 中]              │
│                                                   │
│   パスワード（確認） *                              │
│   ┌─────────────────────────────────────────┐     │
│   │ ••••••••                           [👁]  │     │
│   └─────────────────────────────────────────┘     │
│                                                   │
│   [✓] 利用規約とプライバシーポリシーに同意する       │
│                                                   │
│   ┌─────────────────────────────────────────┐     │
│   │           アカウントを作成                │     │
│   └─────────────────────────────────────────┘     │
│                                                   │
│   ──────────── または ────────────                │
│                                                   │
│   ┌─────────────────────────────────────────┐     │
│   │    [G] Googleで登録                      │     │
│   └─────────────────────────────────────────┘     │
│                                                   │
│   すでにアカウントをお持ちの方 → ログイン           │
│                                                   │
└──────────────────────────────────────────────────┘
```

### 3.3 UI要素詳細

| 要素 | 種類 | バリデーション | 備考 |
|------|------|--------------|------|
| 招待情報バナー | UAlert (color="info") | - | 招待リンク経由の場合のみ表示 |
| 名前 | UInput | MUST: 必須、1-100文字 | |
| メールアドレス | UInput (type="email") | MUST: 必須、メール形式 | 招待時はプリフィル + 編集不可 |
| パスワード | UInput (type="password") | MUST: 必須、8文字以上 | 表示トグル + 強度インジケーター |
| パスワード（確認） | UInput (type="password") | MUST: パスワードと一致 | 表示トグル |
| 利用規約同意 | UCheckbox | MUST: 必須 | リンク付き |
| 登録ボタン | UButton (type="submit") | - | プライマリカラー、幅100% |
| Google 登録ボタン | UButton (variant="outline") | - | Google ブランド準拠 |
| ログインリンク | NuxtLink | - | → /login |

### 3.4 パスワード強度インジケーター

| 強度 | 条件 | 表示 |
|------|------|------|
| 弱 | 8文字以上のみ | 赤バー 33% |
| 中 | 大文字 or 数字を含む | 黄バー 66% |
| 強 | 大文字 + 数字 + 記号を含む | 緑バー 100% |

---

## 4. 状態遷移

### 4.1 遷移ルール

| 現在の状態 | イベント | 次の状態 | アクション |
|-----------|---------|---------|-----------|
| S0 | ページアクセス | S0 | フォーム表示（招待時は招待情報取得） |
| S0 | submit（成功） | S1 | アカウント作成 + 自動ログイン + リダイレクト |
| S0 | submit（失敗） | S0 | エラー表示 |
| S0 | Google OAuth（成功） | S1 | アカウント作成 + 自動ログイン + リダイレクト |
| S1 | ページアクセス | S1 | ロール別リダイレクト先へ |

---

## 5. API仕様

### 5.1 エンドポイント

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | /api/auth/sign-up/email | メール/パスワードサインアップ | 不要 |
| GET | /api/auth/sign-in/social | Google OAuth サインアップ | 不要 |
| GET | /api/v1/invitations/:token | 招待情報取得 | 不要 |
| POST | /api/v1/invitations/:token/accept | 招待承認 + サインアップ | 不要 |

### 5.2 POST /api/auth/sign-up/email（Better Auth 提供）

**リクエスト**:

```json
{
  "name": "山田 太郎",
  "email": "user@example.com",
  "password": "password123"
}
```

| フィールド | 型 | 必須 | バリデーション |
|-----------|-----|------|--------------|
| name | string | MUST | 1-100文字 |
| email | string | MUST | メール形式、最大255文字、未登録 |
| password | string | MUST | 8文字以上、128文字以下 |

**レスポンス（成功）**: `200 OK` + Set-Cookie（セッション Cookie）

```json
{
  "user": {
    "id": "01HXYZ...",
    "email": "user@example.com",
    "name": "山田 太郎",
    "emailVerified": false,
    "image": null
  },
  "session": {
    "id": "session_01ABC...",
    "token": "..."
  }
}
```

### 5.3 POST /api/v1/invitations/:token/accept（カスタム）

招待トークンを検証し、ユーザーをテナントに紐付ける。

**リクエスト**:

```json
{
  "name": "山田 太郎",
  "password": "password123",
  "terms_accepted": true
}
```

> メールアドレスは招待トークンに紐づいているため不要。

**レスポンス（成功）**: `201 Created`

```json
{
  "data": {
    "user": {
      "id": "01HXYZ...",
      "email": "user@example.com",
      "name": "山田 太郎"
    },
    "tenant": {
      "id": "01HTENANT...",
      "name": "ビジョンセンター"
    },
    "role": "venue_staff",
    "redirectTo": "/app"
  }
}
```

**レスポンス（エラー）**:

| HTTPステータス | error.code | 条件 |
|--------------|------------|------|
| 400 | VALIDATION_ERROR | バリデーションエラー |
| 404 | INVITATION_NOT_FOUND | 招待トークン無効 |
| 410 | INVITATION_EXPIRED | 招待期限切れ |
| 409 | INVITATION_ALREADY_USED | 招待使用済み |
| 409 | CONFLICT | メール重複 |

---

## 6. データモデル

### 6.1 関連テーブル

| テーブル | 操作 | 内容 |
|---------|------|------|
| user | INSERT | Better Auth が作成 |
| account | INSERT | Better Auth が作成（パスワードハッシュ） |
| session | INSERT | Better Auth が作成（自動ログイン） |
| user_tenant | INSERT | 招待ベース時：テナント・ロール紐付 |
| invitation（Better Auth） | UPDATE | 招待ステータス更新 |
| verification（Better Auth） | INSERT | メール認証トークン |

### 6.2 招待ベースのデータフロー

```
1. 管理者が招待作成 → invitation テーブルに INSERT
2. 招待メール送信（/signup?token=xxx）
3. ユーザーがフォーム入力 → /api/v1/invitations/:token/accept
4. トランザクション内で:
   a. Better Auth でユーザー + アカウント作成
   b. user_tenant に INSERT（tenant_id, role は招待から取得）
   c. invitation のステータスを accepted に更新
   d. セッション作成
```

---

## 7. ビジネスロジック

### 7.1 招待ベース サインアップフロー

```
1. 招待トークン検証（GET /api/v1/invitations/:token）
   ├─ トークン無効 → 404 エラーページ
   ├─ 期限切れ → 410 エラーページ（再招待リンク表示）
   ├─ 使用済み → 409 エラーページ（ログインリンク表示）
   └─ 有効 → フォーム表示（テナント名・ロール・メールをプリフィル）

2. フォーム入力バリデーション
   ├─ 名前: 必須、1-100文字
   ├─ パスワード: 8文字以上
   ├─ 利用規約: 同意必須
   └─ 失敗 → フィールドエラー表示

3. POST /api/v1/invitations/:token/accept
   ├─ Better Auth でユーザー作成
   ├─ user_tenant に INSERT（is_default = true）
   ├─ invitation を accepted に更新
   ├─ セッション作成 + Cookie セット
   └─ ロール別リダイレクト先を返却

4. フロントエンドがリダイレクト先に遷移
```

### 7.2 セルフ登録 サインアップフロー

```
1. /signup にアクセス（招待トークンなし）

2. フォーム入力バリデーション（上記と同じ）

3. Better Auth signUp.email() 呼び出し
   ├─ ユーザー + アカウント作成
   ├─ セッション作成 + Cookie セット
   └─ メール認証トークン生成 + 確認メール送信

4. user_tenant は作成されない（テナント未所属状態）
   → オンボーディング画面（/app/onboarding）へ遷移
   → 管理者がテナント・ロールを設定するまで機能制限
```

### 7.3 Google OAuth サインアップフロー

```
1. 「Googleで登録」ボタンクリック

2. Better Auth signIn.social({ provider: "google" }) 呼び出し
   → Google OAuth 画面にリダイレクト

3. Google 認証完了 → コールバック
   ├─ 招待トークンあり → テナント・ロール自動設定
   └─ 招待トークンなし → セルフ登録扱い

4. セッション作成 + リダイレクト
```

### 7.4 セキュリティ要件

| 要件 | 実装 |
|------|------|
| パスワードハッシュ | Better Auth 内部の bcrypt |
| レート制限 | 同一IP: 5回/時間 |
| 招待トークン | crypto.randomBytes(32)、ハッシュ化保存 |
| 招待有効期限 | 7日間 |
| メール認証 | Better Auth 標準（確認メール送信） |

---

## 8. エラーハンドリング

### 8.1 フロントエンド

| エラー種別 | 表示方法 | メッセージ |
|-----------|---------|-----------|
| フィールドエラー | UFormGroup error | バリデーションメッセージ |
| メール重複 | UAlert (color="error") | 「このメールアドレスは既に登録されています」 |
| 招待無効 | エラーページ | 「招待リンクが無効です」 |
| 招待期限切れ | エラーページ | 「招待リンクの有効期限が切れています。管理者に再招待をご依頼ください」 |
| レート制限 | UAlert (color="warning") | 「しばらく時間をおいて再試行してください」 |
| ネットワークエラー | UAlert (color="error") | 「通信エラーが発生しました」 |

### 8.2 バックエンド

| エラー種別 | HTTPステータス | ログレベル |
|-----------|--------------|-----------|
| バリデーションエラー | 400 | DEBUG |
| メール重複 | 409 | INFO |
| 招待無効 | 404/410/409 | INFO |
| メール送信失敗 | - | WARN（アカウントは作成済み） |
| サーバーエラー | 500 | ERROR |

---

## 9. テスト仕様

### 9.1 ユニットテスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-001 | 有効な情報でサインアップ | ユーザー作成 |
| TC-002 | メール重複 | 409 エラー |
| TC-003 | パスワード短すぎ | 400 エラー |
| TC-004 | パスワード不一致 | 400 エラー |
| TC-005 | 名前が空 | 400 エラー |
| TC-006 | 利用規約未同意 | 400 エラー |
| TC-007 | 招待トークン無効 | 404 エラー |
| TC-008 | 招待期限切れ | 410 エラー |

### 9.2 統合テスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-101 | 招待ベースサインアップ → user_tenant 作成 | テナント・ロール紐付 |
| TC-102 | セルフ登録 → テナント未所属 | user_tenant なし |
| TC-103 | Google OAuth サインアップ | ユーザー + account 作成 |
| TC-104 | メール送信失敗 → アカウントは作成 | ユーザーあり、メール未送信 |

### 9.3 E2Eテスト

| テストID | テストケース | 期待結果 |
|----------|-------------|---------|
| TC-201 | 招待ベースサインアップフロー | ロール別リダイレクト先に遷移 |
| TC-202 | セルフ登録フロー | オンボーディングに遷移 |
| TC-203 | Google OAuth サインアップフロー | 正常にアカウント作成 + ログイン |
| TC-204 | ログイン済みで /signup アクセス | ロール別リダイレクト先に遷移 |

---

## 10. 非機能要件

| 指標 | 目標値 |
|------|-------|
| API 応答時間（p95） | < 1s（bcrypt 含む） |
| ページ読み込み（LCP） | < 2.5秒 |

---

## 11. 依存関係

### 11.1 前提となる機能

なし（最初に実装可能）

### 11.2 この機能に依存する機能

| 機能ID | 機能名 | 依存内容 |
|--------|-------|---------|
| AUTH-001 | ログイン | user テーブル |
| AUTH-007 | メール認証 | verification テーブル |
| ACCT-002 | プロフィール表示 | user テーブル |

---

## 12. 未決定事項・制約 [DETAIL]

### 12.1 未決定事項（TBD）

| # | 項目 | 層 | 理由 | デフォルト案 |
|---|------|-----|------|------------|
| - | - | - | 全て決定済み | - |

> CORE層・CONTRACT層のTBDはゼロ。DETAIL層のTBDもゼロ。

### 12.2 前提条件

- Better Auth v1.4+ がインストール済み
- PostgreSQL 16 が稼働中
- BETTER_AUTH_SECRET 環境変数が設定済み
- メール送信サービス（Resend等）が設定済み
- Google OAuth のクライアントID/シークレットは任意

### 12.3 制約事項

- ユーザー作成は Better Auth の signUp.email() に委譲
- パスワードハッシュは Better Auth 内部の bcrypt に委譲
- 招待トークンは crypto.randomBytes(32) でハッシュ化保存
- 招待有効期限は7日間固定
- セルフ登録ユーザーはテナント未所属（user_tenant レコードなし）
- OAuth プロバイダは Google のみ（Microsoft は Phase 2）
- メール送信失敗時もアカウント作成は成功させる（後で再送可能）

---

## 13. 実装メモ（AI向け）

### 13.1 実装順序

```
1. Better Auth セットアップ（AUTH-001 と共有）
2. 招待 API（GET /api/v1/invitations/:token, POST accept）
3. pages/signup.vue — サインアップフォーム
4. 招待リンク経由のフロー
5. Google OAuth サインアップフロー
6. テスト
```

### 13.2 注意事項

- ⚠️ パスワードは絶対にログに出力しない
- ⚠️ メール送信は非同期で行う（API レスポンスを遅延させない）
- ⚠️ 招待トークンはハッシュ化して保存
- ⚠️ セルフ登録ユーザーはテナント未所属（機能制限あり）
- ⚠️ Google OAuth で既存メールと一致する場合はアカウントリンク

---

## カスタマイズ差分（テンプレートとの差異）

| セクション | 変更内容 | 理由 |
|-----------|---------|------|
| §1.3 スコープ | 招待ベース + セルフ登録の両方対応 | ユーザー確認 |
| §1.3 スコープ | Google OAuth サインアップ追加 | ユーザー確認 |
| §2.1 受入条件 | 招待関連の AC 追加 | 招待ベース対応 |
| §3.2 UI | 招待情報バナー追加 | 招待ベース対応 |
| §5 API | JWT → Cookie セッション（Better Auth） | Better Auth 標準 |
| §5 API | 招待 API 追加 | 招待ベース対応 |
| §7 ビジネスロジック | 3パターンのフロー定義 | 招待/セルフ/OAuth |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|----------|---------|-------|
| 2026-02-09 | v1.0 | 初版作成（テンプレートからカスタマイズ） | AI |
| 2026-02-09 | v1.1 | §2.4-2.7 追加（入出力例12件、境界値7項目、例外レスポンス11件、Gherkin 14シナリオ）。§12 未決定事項・制約追加 | AI |
